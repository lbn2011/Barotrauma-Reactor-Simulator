# Barotrauma反应堆模拟器详细优化分析报告

## 项目现状分析

基于对项目代码和切尔诺贝利遗产延续手册详细技术文档的深度分析，当前项目已经实现了一个功能相对完整的RBMK-1000反应堆模拟器，包括22个控制面板和基本的物理模拟系统。然而，通过与真实RBMK-1000系统和参考资料的对比，仍有较大的优化空间。

## 一、RBMK-1000反应堆技术特性深度分析

### 1.1 RBMK-1000核心设计特性

**真实RBMK-1000的关键特性**：
- **石墨慢化**：使用石墨作为慢化剂而非水，这是RBMK设计的核心特征
- **正空泡系数**：当反应堆形成空泡（水变成蒸汽）时，堆芯功率增加而非减少
- **在线换料**：世界上唯一具有此特点的商业动力堆之一（除加拿大CANDU外）
- **未浓缩铀燃料**：出于经济原因使用未浓缩铀，导致反应堆中毒问题
- **控制棒设计缺陷**：控制棒尖端使用石墨"水置换器"，导致紧急停堆时功率瞬间增加
- **缺乏安全壳结构**：没有压力密封的安全壳来容纳放射性物质

**当前模拟器状态**：
- 基本控制棒功能已实现，但缺乏真实的物理响应特性
- 缺乏正空泡系数效应的准确模拟
- 氙中毒效应有基础实现，但不够详细
- 控制棒响应时间与真实值不符（真实值需要30秒以上完全插入）

### 1.2 真实RBMK-1000技术参数

**反应堆核心参数**：
- 额定热输出：3000 MW
- 额定电输出：1000 MW
- 工作压力：约6.5-7.0 MPa
- 堆芯温度：正常运行时280-320°C
- 冷却剂流量：每回路约40,000 m³/h
- 控制棒数量：211根控制棒
- 控制棒插入速度：约0.5-1 cm/s
- 控制棒完全插入时间：30秒以上

**汽轮机参数**：
- 额定转速：3600 RPM（美国标准）/ 3000 RPM（欧洲标准）
- 涡轮机重量：数百吨
- 滑行停机时间：最长3小时
- 润滑油系统：必须持续运行，包括备用直流油泵
- 液压油系统：独立于润滑油系统

**辅助系统参数**：
- 凝汽器真空：应维持在95%以上（约0.05 MPa绝对压力）
- 除氧器压力：16-25 psig（约0.11-0.17 MPa）
- 除氧器水位：正常0英寸
- 热井水位：正常0英寸
- 凝结水储罐容量：每个960,000加仑（约3,634,000升）

## 二、真实性优化详细建议

### 2.1 物理模型深度优化

#### 2.1.1 热工水力模型增强

**当前状态**：
- 简单的线性模型（如温度 = 250 + 功率 × 0.8）
- 有限的系统间相互影响
- 缺乏真实的热工水力计算

**详细优化建议**：

**1. 实现质量守恒方程**

质量守恒模型需要建立反应堆、凝汽器和除氧器三个关键系统的质量平衡计算。对于反应堆系统，需要跟踪给水流量、蒸汽流量、水位、压力和温度等参数的变化。给水流量代表进入系统的质量，蒸汽流量代表离开系统的质量，两者的差值决定了水位的变化。压力和温度的变化会影响水的密度，从而影响质量平衡的计算。

凝汽器系统的质量平衡需要考虑蒸汽入口流量、凝结水出口流量、冷却水流量和真空度等参数。蒸汽进入凝汽器后被冷凝成水，凝结水出口流量应与蒸汽入口流量加上冷却水带来的质量变化相平衡。真空度是凝汽器性能的关键指标，需要维持在95%以上。

除氧器系统的质量平衡涉及给水入口、蒸汽入口、出口流量、液位和压力等参数。除氧器通过加热给水来去除溶解氧，蒸汽入口用于加热，给水入口提供待处理的水，出口流量是处理后的给水流量。液位和压力的控制对于除氧器的正常运行至关重要。

**2. 实现能量守恒方程**

能量守恒模型需要建立反应堆、汽轮机和发电机三个系统的能量平衡计算。对于反应堆系统，需要跟踪核功率、热功率、蒸汽生成量、冷却剂热容和温升等参数。核功率通过裂变反应产生，转化为热功率，热功率用于产生蒸汽。蒸汽生成量取决于热功率和冷却剂的热容，温升反映了热能传递的效率。

汽轮机系统的能量平衡需要考虑入口蒸汽焓、出口蒸汽焓、机械功率和效率等参数。蒸汽在汽轮机中膨胀做功，将热能转化为机械能。入口蒸汽焓代表进入汽轮机的热能，出口蒸汽焓代表离开汽轮机的剩余热能，两者的差值转化为机械功率。汽轮机的效率通常在85%左右。

发电机系统的能量平衡涉及机械输入、电输出、损失和效率等参数。机械功率通过汽轮机传递给发电机，转化为电能。电输出是实际可用的电能，损失包括机械损失、电气损失等。发电机的效率通常在95%以上。

**3. 考虑冷却剂流动的阻力损失**

流动阻力模型需要建立管道流动阻力和泵性能特性的计算。对于管道流动阻力，需要考虑管道直径、长度、粗糙度、流量、压降、雷诺数和摩擦系数等参数。管道的直径和长度决定了流动的几何特性，粗糙度影响摩擦系数，流量决定了流动状态。压降是流体通过管道时的压力损失，雷诺数用于判断流动是层流还是湍流，摩擦系数反映了管道内表面的粗糙程度对流动的影响。

泵性能特性需要考虑扬程、流量、功率、效率和净正吸入扬程等参数。扬程是泵能够提升液体的高度，流量是泵输送液体的能力，功率是泵消耗的能量，效率是泵输出功率与输入功率的比值，净正吸入扬程是泵正常运行所需的最小吸入压力。这些参数相互关联，需要建立完整的泵性能曲线来准确模拟泵的工作状态。

**4. 模拟不同压力下的水/蒸汽特性**

水/蒸汽热力学特性模型需要建立压力、温度、饱和温度、液体焓、蒸汽焓、液体熵、蒸汽熵、液体密度、蒸汽密度和空泡分数等参数的计算关系。压力和温度是状态参数，决定了水的热力学状态。饱和温度是在给定压力下水开始沸腾的温度，液体焓和蒸汽焓分别代表液态水和蒸汽的热含量，液体熵和蒸汽熵代表系统的无序程度，液体密度和蒸汽密度反映物质的状态，空泡分数表示蒸汽在两相流中的比例。

为了准确计算这些参数，应该使用国际公认的IAPWS-97（国际水和蒸汽性质协会）标准公式。这些公式基于大量的实验数据，能够精确计算水和蒸汽在各种压力和温度下的热力学性质。饱和温度的计算需要基于压力值，空泡分数的计算需要考虑压力和温度的关系。液体焓、蒸汽焓、液体熵、蒸汽熵、液体密度和蒸汽密度都需要使用相应的热力学公式进行计算。这些参数对于准确模拟反应堆的热工水力行为至关重要。

#### 2.1.2 中子物理模型增强

**1. 正空泡系数效应**

正空泡系数模型需要建立基础反应性、空泡分数、空泡系数、功率变化和反馈延迟等参数的计算关系。基础反应性是反应堆在正常状态下的反应性水平，空泡分数表示堆芯中蒸汽所占的比例，空泡系数是RBMK反应堆的关键特性，为正值表示空泡分数增加会导致反应性增加。功率变化是空泡系数效应的直接结果，反馈延迟表示从空泡分数变化到功率变化响应的时间滞后。

正空泡系数的计算需要考虑空泡分数对反应性的影响。当反应堆中形成空泡（水变成蒸汽）时，由于石墨慢化剂的存在，中子慢化效率提高，导致反应性增加，进而使功率上升。这种正反馈机制是RBMK反应堆设计的关键特征，也是切尔诺贝利事故的重要原因之一。计算时需要将空泡分数乘以空泡系数得到反应性变化，然后用反应性变化计算功率乘数，最后用当前功率乘以功率乘数得到新的功率水平。反馈延迟需要考虑热工水力系统的响应时间，通常为几秒到几十秒。

**2. 氙-135中毒效应**

氙-135中毒模型需要建立氙浓度、碘浓度、中子通量、功率水平、中毒因子和恢复时间等参数的计算关系。氙浓度是堆芯中氙-135的浓度水平，碘浓度是碘-135的浓度水平，中子通量表示中子的密度，功率水平与中子通量成正比，中毒因子表示氙中毒对反应性的影响程度，恢复时间表示从中毒状态恢复到正常状态所需的时间。

氙-135动力学方程需要考虑氙-135的产生率和衰变率。氙-135主要通过两个途径产生：一是碘-135的衰变，二是铀-235裂变直接产生。氙-135的衰变主要通过两个途径：一是自然衰变，二是中子俘获。碘-135的产生主要来自铀-235裂变，衰变产生氙-135。

计算氙-135中毒对反应性的影响需要考虑氙浓度、中子俘获截面和热中子通量。氙-135具有巨大的中子俘获截面，能够吸收大量中子，从而降低反应性。氙中毒对反应性的影响是负值，表示反应性的损失。氙中毒的恢复时间通常为数小时，这是反应堆运行中需要考虑的重要因素，特别是在功率变化后的重新启动过程中。

**3. 控制棒物理特性**

控制棒物理模型需要建立位置、插入速度、石墨尖端效应、水置换效应、反应性价值和延迟响应时间等参数的计算关系。位置表示控制棒插入堆芯的深度，通常以百分比表示，插入速度是控制棒移动的速度，石墨尖端效应是指控制棒尖端使用石墨"水置换器"的设计特性，水置换效应表示控制棒插入时置换水对反应性的影响，反应性价值表示控制棒对反应性的控制能力，延迟响应时间表示控制棒动作到反应性变化响应的时间滞后。

控制棒插入时的功率瞬态需要考虑石墨尖端效应和延迟的吸收效应。石墨尖端效应是指当控制棒开始插入时，由于石墨尖端比水更能慢化中子，导致反应性短暂增加，功率上升。这种效应通常发生在控制棒插入的前20%深度范围内。延迟的吸收效应是指控制棒插入后，吸收材料逐渐进入堆芯，开始吸收中子，导致反应性下降，功率降低。

控制棒完全插入的时间在真实RBMK-1000中需要30秒以上，插入速度约为0.5-1厘米/秒。这个响应时间对于准确模拟反应堆的动态行为至关重要，特别是在紧急停堆情况下。控制棒的延迟响应时间需要考虑机械系统的惯性和热工水力系统的响应时间，通常为几秒到几十秒。

#### 2.1.3 系统间耦合增强

**1. 给水系统-堆芯水位耦合**

给水-堆芯耦合模型需要建立给水流量、给水温度、堆芯水位、堆芯温度、蒸汽生成量和水位响应时间等参数的计算关系。给水流量是进入反应堆的水流量，给水温度是给水的温度，堆芯水位是反应堆内的水位高度，堆芯温度是反应堆内的温度，蒸汽生成量是产生的蒸汽流量，水位响应时间是水位变化对给水流量变化的响应时间。

堆芯水位的计算需要考虑质量平衡原理。给水流量代表进入系统的质量，蒸汽生成量代表离开系统的质量，两者的差值决定了水位的变化。水位变化等于质量平衡乘以时间步长，再除以堆芯横截面积。堆芯横截面积是反应堆的几何参数，需要根据实际设计确定。水位响应时间需要考虑热工水力系统的惯性，通常为几秒到几十秒。给水温度会影响堆芯温度，进而影响蒸汽生成量，形成耦合效应。

**2. 蒸汽压力-汽轮机效率耦合**

蒸汽压力-汽轮机耦合模型需要建立蒸汽压力、蒸汽温度、汽轮机效率、汽轮机负荷和蒸汽流量等参数的计算关系。蒸汽压力是进入汽轮机的蒸汽压力，蒸汽温度是进入汽轮机的蒸汽温度，汽轮机效率是汽轮机将热能转化为机械能的效率，汽轮机负荷是汽轮机的机械负荷，蒸汽流量是通过汽轮机的蒸汽流量。

汽轮机效率的计算需要基于蒸汽参数和负荷。压力因子是蒸汽压力与额定压力的比值，额定压力通常为7.0兆帕。温度因子是蒸汽温度与额定温度的比值，额定温度通常为280摄氏度。负荷因子是汽轮机负荷的函数，通常在0.8到1.0之间变化，反映了汽轮机在不同负荷下的效率特性。

汽轮机的效率通常在85%左右，但会随着蒸汽参数和负荷的变化而变化。当蒸汽压力和温度低于额定值时，效率会下降。当汽轮机负荷偏离最佳工作点时，效率也会下降。蒸汽流量与汽轮机负荷成正比，需要根据汽轮机的特性曲线进行计算。这种耦合效应对于准确模拟汽轮机的动态行为至关重要。

**3. 凝结水温度-除氧器性能耦合**

凝结水-除氧器耦合模型需要建立凝结水温度、凝结水流量、除氧器压力、除氧器效率和含氧量等参数的计算关系。凝结水温度是进入除氧器的凝结水温度，凝结水流量是进入除氧器的凝结水流量，除氧器压力是除氧器内的压力，除氧器效率是除氧器去除溶解氧的效率，含氧量是处理后给水中的氧含量。

除氧器效率的计算需要考虑温度和压力的影响。饱和温度是在给定压力下水的饱和温度，温度接近度是饱和温度与凝结水温度的差值。温度接近度越小，说明凝结水温度越接近饱和温度，除氧器效率越高。效率因子是温度接近度的函数，当温度接近度为零时，效率因子为1，当温度接近度增加时，效率因子下降。

除氧器的效率通常在95%左右，但会随着凝结水温度和压力的变化而变化。当凝结水温度低于饱和温度时，除氧器效率会下降。当除氧器压力变化时，饱和温度也会变化，进而影响除氧器效率。含氧量是除氧器性能的重要指标，需要控制在很低的水平，通常以ppb（十亿分之一）为单位。蒸汽流量用于加热凝结水，蒸汽流量越大，凝结水温度越接近饱和温度，除氧器效率越高。

### 2.2 系统完整性详细优化

#### 2.2.1 完善系统细节

**1. 蒸汽发生器水位控制系统**

蒸汽发生器水位控制需要建立水位、设定值、给水流量、蒸汽流量、控制模式和水位警报等参数的控制关系。水位是蒸汽发生器内的实际水位，设定值是期望的水位，给水流量是进入蒸汽发生器的给水流量，蒸汽流量是离开蒸汽发生器的蒸汽流量，控制模式可以是单冲量或三冲量控制，水位警报包括高水位、低水位、高高水位和低低水位警报。

三冲量水位控制是一种先进的控制策略，同时考虑水位、蒸汽流量和给水流量三个参数。水位误差是设定值与实际水位的差值，流量误差是蒸汽流量与给水流量的差值。水位控制器根据水位误差计算给水流量的调整量，流量控制器根据流量误差计算给水流量的调整量。最终的给水流量调整量是水位控制器和流量控制器输出的总和。

水位警报需要设置多个阈值，包括高水位警报、低水位警报、高高水位警报和低低水位警报。当水位超过这些阈值时，系统会发出警报并采取相应的控制措施。高高水位和低低水位警报通常会导致紧急停堆或紧急停机，以防止设备损坏。三冲量控制比单冲量控制更稳定，能够更好地应对负荷变化。

**2. 汽轮机旁路系统**

汽轮机旁路系统需要建立旁路阀门、蒸汽压力和汽轮机状态等参数的控制关系。旁路阀门包括阀门位置、容量和压力设定点等参数。阀门位置表示旁路阀的开度，容量表示旁路阀的最大流量能力，压力设定点是旁路阀控制的蒸汽压力目标值。蒸汽压力是系统的实际蒸汽压力，汽轮机状态包括在线、离线和旁路三种状态。

旁路系统的控制逻辑需要根据汽轮机状态和蒸汽压力来确定。当汽轮机离线时，旁路阀需要控制蒸汽压力，通过调节阀门位置来维持压力设定点。压力误差是实际压力与设定点的差值，阀门位置根据压力误差进行调节。当汽轮机在线但蒸汽压力过高时（超过设定点的105%），旁路阀需要部分开启，通过旁路部分蒸汽来降低压力。旁路阀的开度与压力超调量成正比，但最大不超过100%。

汽轮机旁路系统是核电站的重要安全系统，能够在汽轮机故障或停机时维持反应堆的正常运行。旁路阀的容量需要足够大，能够旁路全部蒸汽流量。压力设定点通常略低于正常工作压力，以确保旁路系统能够及时响应压力变化。旁路系统的响应时间需要足够快，以防止压力过高导致安全阀动作。

**3. 堆芯冷却剂净化系统**

冷却剂净化系统需要建立流量、效率、杂质水平、过滤状态和化学添加等参数的控制关系。流量是净化系统的处理流量，效率是净化系统的净化效率，杂质水平是冷却剂中的杂质浓度，过滤状态包括过滤器1和过滤器2的状态，化学添加包括硼酸添加和pH控制剂添加。

净化效率的计算需要考虑流量、杂质水平和过滤器效率。流量因子是实际流量与最大流量的比值，最大流量是净化系统的设计容量。杂质因子是杂质水平与最大杂质水平的比值，最大杂质水平是系统能够处理的最大杂质浓度。净化效率是过滤器效率、流量因子和杂质因子的乘积。当流量接近最大流量时，流量因子接近1；当杂质水平接近最大杂质水平时，杂质因子接近0。

过滤器的状态包括在线、离线和再生三种状态。在线状态表示过滤器正在工作，离线状态表示过滤器停止工作，再生状态表示过滤器正在进行再生处理。化学添加系统用于控制冷却剂的化学性质，硼酸用于控制反应性，pH控制剂用于维持冷却剂的pH值。净化系统的目标是保持冷却剂的化学性质和杂质水平在规定范围内，防止腐蚀和沉积。

#### 2.2.2 实现真实的启动流程

**基于手册的15步启动程序详细实现**：

**启动前准备阶段**：

启动前准备需要建立屏幕视图优化、趋势设置、凝结水储罐检查和热井水位检查等准备工作。屏幕视图优化包括示意图显示、趋势显示和警报显示的设置，这些显示对于操作员监控系统状态至关重要。趋势设置需要为关键参数配置趋势图，包括反应堆水位、除氧器水位、热井水位、给水流量、蒸汽流量、中子率、中子通量、热功率、凝汽器真空和发电机负荷等参数，每个参数都需要指定颜色和启用状态。

凝结水储罐检查需要确认罐1和罐2的水位，最低要求为50%。凝结水储罐是系统的重要水源，必须确保有足够的水量用于启动和运行。热井水位检查需要确认水位和设定值，通常设定值为0英寸，控制模式可以是自动或手动。热井水位是凝汽器的重要参数，需要维持在适当的范围内以确保凝汽器的正常运行。

这些准备工作是启动流程的基础，必须在反应堆启动前完成。屏幕视图的优化能够帮助操作员更好地监控系统状态，趋势设置能够提供历史数据用于分析，凝结水储罐和热井水位的检查能够确保系统有足够的水量用于启动。

**系统启动阶段**：

系统启动程序需要建立凝结水泵启动、除氧器注水、凝结水精处理系统、凝汽器循环水泵和HEPA过滤器检查等启动步骤。凝结水泵启动需要选择泵号（1、2或3），监控泵的状态（启动中、运行中或停止），跟踪流量和排放压力。凝结水泵是系统的重要设备，需要确保正常运行以提供足够的凝结水流量。

除氧器注水需要监控水位、控制模式和流量阀位置。除氧器水位需要维持在适当的范围内，控制模式可以是手动或自动。流量阀位置控制进入除氧器的给水流量，需要根据水位进行调节。除氧器注水是启动流程的重要步骤，需要确保除氧器有足够的水量用于后续的启动过程。

凝结水精处理系统包括精处理器1和精处理器2，每个精处理器都有状态和效率参数。再生模式表示精处理器是否正在进行再生处理。凝结水精处理系统用于去除凝结水中的杂质，确保给水质量符合要求。凝汽器循环水泵需要选择泵号（1或2），监控泵的状态、流量，流量最低要求为500,000加仑/分钟。凝汽器循环水泵是凝汽器的重要设备，需要提供足够的冷却水流量以维持凝汽器的真空度。

HEPA过滤器检查需要确认状态（在线、离线或旁路）、旁路流量、辐射水平和过滤器效率。HEPA过滤器用于过滤放射性物质，需要确保其正常运行以保护环境。辐射水平需要监控，过滤器效率需要维持在规定的范围内。这些启动步骤必须按照规定的顺序执行，确保系统的安全启动。

**反应堆启动阶段**：
```typescript
// 反应堆启动程序
interface ReactorStartupProcedure {
  // 第10步：反应堆给水泵
  reactorFeedPump: {
    pumpNumber: 1 | 2 | 3;
    status: 'starting' | 'running' | 'stopped';
    flowRate: number;            // 流量 (GPM)
    dischargePressure: number;    // 排放压力 (psig)
  };
  
  // 第11步：反应堆鼓水位控制
  drumLevelControl: {
    controlMode: 'single' | 'three-element';
    activeValve: 'startup' | 'main';
    setpoint: number;            // 设定值 (%)
    currentLevel: number;        // 当前水位 (%)
  };
  
  // 第12步：紧急堆芯冷却系统
  emergencyCoreCooling: {
    status: 'standby' | 'active' | 'offline';
    autoMode: boolean;
    pump1: { status: string; flowRate: number };
    pump2: { status: string; flowRate: number };
    dieselPump: { status: string; flowRate: number };
  };
  
  // 第13步：反应堆紧急停堆控制
  reactorScramControl: {
    status: 'armed' | 'disarmed';
    protectionCircuits: string[];
    lastScramTime: number;
  };
  
  // 第14步：再循环泵启动
  recirculationPump: {
    loop1: { pump1: string; pump2: string };
    loop2: { pump1: string; pump2: string };
    minimumRequired: 'one_per_loop';
  };
}

async function executeReactorStartup(): Promise<ReactorStartupProcedure> {
  // 启动反应堆给水泵
  const feedPump = await startReactorFeedPump(1);
  
  // 设置反应堆鼓水位控制
  const drumLevel = await setupDrumLevelControl();
  
  // 检查紧急堆芯冷却系统
  const eccSystem = await checkEmergencyCoreCooling();
  
  // 检查反应堆紧急停堆控制
  const scramControl = await checkReactorScramControl();
  
  // 启动再循环泵
  const recircPumps = await startRecirculationPumps();
  
  return {
    reactorFeedPump: feedPump,
    drumLevelControl: drumLevel,
    emergencyCoreCooling: eccSystem,
    reactorScramControl: scramControl,
    recirculationPump: recircPumps
  };
}
```

**汽轮机启动阶段**：
```typescript
// 汽轮机启动程序
interface TurbineStartupProcedure {
  // 第15步：停止离线堆芯冷却
  offlineCoreCooling: {
    status: 'stopping' | 'stopped';
    inletValve: 'open' | 'closed';
    outletValve: 'open' | 'closed';
  };
  
  // 第16步：除氧器蒸汽供应
  deaeratorSteamSupply: {
    pressure: number;            // 压力 (psig)
    setpoint: number;            // 设定值 (psig)
    controlMode: 'auto' | 'manual';
    exhaustValvePosition: number; // 排气阀位置 (%)
  };
  
  // 第17步：主蒸汽排放控制
  mainSteamDump: {
    pressureSetpoint: number;    // 压力设定点 (psig)
    valvePosition: number;       // 阀门位置 (%)
    controlMode: 'auto' | 'manual';
  };
  
  // 第18步：反应堆疏水控制
  reactorDrain: {
    levelSetpoint: number;       // 水位设定点 (英寸)
    valvePosition: number;       // 阀门位置 (%)
    controlMode: 'auto' | 'manual';
  };
  
  // 第19步：涡轮机辅助系统
  turbineAuxiliary: {
    lubricationOil: {
      systemStatus: 'starting' | 'running' | 'stopped';
      pressure: number;          // 压力 (psig)
      temperature: number;       // 温度 (°C)
      backupSystem: 'standby' | 'active';
    };
    hydraulicOil: {
      systemStatus: 'starting' | 'running' | 'stopped';
      pressure: number;          // 压力 (psig)
      valveControl: 'normal' | 'emergency';
    };
    turningGear: {
      status: 'engaged' | 'disengaged';
      rpm: number;               // 转速 (RPM)
    };
    steamSeal: {
      status: 'starting' | 'running' | 'stopped';
      pressure: number;          // 压力 (psig)
    };
  };
}

async function executeTurbineStartup(): Promise<TurbineStartupProcedure> {
  // 停止离线堆芯冷却
  const offlineCooling = await stopOfflineCoreCooling();
  
  // 设置除氧器蒸汽供应
  const deaeratorSteam = await setupDeaeratorSteamSupply();
  
  // 设置主蒸汽排放控制
  const steamDump = await setupMainSteamDump();
  
  // 设置反应堆疏水控制
  const reactorDrain = await setupReactorDrain();
  
  // 启动涡轮机辅助系统
  const turbineAux = await startTurbineAuxiliary();
  
  return {
    offlineCoreCooling: offlineCooling,
    deaeratorSteamSupply: deaeratorSteam,
    mainSteamDump: steamDump,
    reactorDrain: reactorDrain,
    turbineAuxiliary: turbineAux
  };
}
```

**临界和并网阶段**：
```typescript
// 临界和并网程序
interface CriticalityAndGridConnection {
  // 第20步：真空系统启动
  vacuumSystem: {
    status: 'starting' | 'running' | 'stopped';
    vacuumLevel: number;        // 真空度 (%)
    vacuumBreaker: 'open' | 'closed';
    minimumSteamPressure: 250;  // 最低蒸汽压力 (psig)
  };
  
  // 第21步：蒸汽压力建立
  steamPressureBuildup: {
    currentPressure: number;     // 当前压力 (psig)
    targetPressure: number;     // 目标压力 (psig)
    dumpValvePosition: number;   // 排放阀位置 (%)
  };
  
  // 第22步：涡轮机复位
  turbineReset: {
    status: 'resetting' | 'reset' | 'failed';
    speedSetpoint: number;       // 速度设定点 (RPM)
    clearanceConditions: string[];
  };
  
  // 第23步：反应堆功率控制设置
  reactorPowerControl: {
    autoControl: boolean;
    powerSetpoint: number;       // 功率设定点 (%)
    scramReset: boolean;
  };
  
  // 第24步：控制棒提升
  controlRodWithdrawal: {
    mode: 'center_only' | 'all_rods';
    speed: 'slow' | 'medium' | 'fast';
    criticalityStatus: 'subcritical' | 'critical' | 'supercritical';
    negativeLogFlux: number;     // 负对数通量
  };
  
  // 第25步：涡轮机启动
  turbineStartup: {
    mode: 'auto' | 'manual';
    currentSpeed: number;        // 当前转速 (RPM)
    speedStops: [900, 1800, 2700, 3600];
    vibration: number;           // 振动 (mm/s)
    differentialExpansion: number; // 差胀 (mm)
  };
  
  // 第26步：发电机同步
  generatorSynchronization: {
    syncIndicator: 'off' | 'rotating' | 'stable';
    syncSpeed: number;           // 同步速度 (RPM)
    breakerStatus: 'open' | 'closed';
    syncAngle: number;           // 同步角度 (度)
  };
}

async function executeCriticalityAndGridConnection(): Promise<CriticalityAndGridConnection> {
  // 启动真空系统
  const vacuumSystem = await startVacuumSystem();
  
  // 建立蒸汽压力
  const steamPressure = await buildSteamPressure();
  
  // 涡轮机复位
  const turbineReset = await resetTurbine();
  
  // 设置反应堆功率控制
  const powerControl = await setupReactorPowerControl();
  
  // 控制棒提升
  const rodWithdrawal = await withdrawControlRods();
  
  // 涡轮机启动
  const turbineStartup = await startupTurbine();
  
  // 发电机同步
  const generatorSync = await synchronizeGenerator();
  
  return {
    vacuumSystem,
    steamPressureBuildup: steamPressure,
    turbineReset,
    reactorPowerControl: powerControl,
    controlRodWithdrawal: rodWithdrawal,
    turbineStartup,
    generatorSynchronization: generatorSync
  };
}
```

#### 2.2.3 增强故障模拟

**1. 管道破裂故障**
```typescript
// 管道破裂故障模型
interface PipeRuptureFault {
  location: 'primary' | 'secondary' | 'feedwater' | 'steam';
  ruptureSize: 'small' | 'medium' | 'large' | 'catastrophic';
  ruptureArea: number;           // 破裂面积 (cm²)
  leakRate: number;              // 泄漏率 (kg/s)
  pressureDrop: number;          // 压降 (MPa)
  waterLoss: number;             // 水损失 (kg)
  detectionTime: number;         // 检测时间 (秒)
  isolationStatus: 'detected' | 'isolating' | 'isolated' | 'failed';
}

function simulatePipeRupture(
  location: string,
  ruptureSize: string,
  systemPressure: number
): PipeRuptureFault {
  const ruptureAreas = {
    small: 10,
    medium: 50,
    large: 200,
    catastrophic: 1000
  };
  
  const ruptureArea = ruptureAreas[ruptureSize as keyof typeof ruptureAreas];
  const leakRate = calculateLeakRate(ruptureArea, systemPressure);
  const pressureDrop = calculatePressureDrop(leakRate, location);
  
  return {
    location: location as any,
    ruptureSize: ruptureSize as any,
    ruptureArea,
    leakRate,
    pressureDrop,
    waterLoss: 0,
    detectionTime: calculateDetectionTime(ruptureSize),
    isolationStatus: 'detected'
  };
}

function calculateLeakRate(area: number, pressure: number): number {
  // 使用伯努利方程计算泄漏率
  const dischargeCoefficient = 0.6;
  const waterDensity = 1000; // kg/m³
  const gravity = 9.81; // m/s²
  
  return dischargeCoefficient * area * Math.sqrt(2 * pressure * 1e6 / waterDensity);
}
```

**2. 泵故障**
```typescript
// 泵故障模型
interface PumpFault {
  pumpId: string;
  faultType: 'mechanical' | 'electrical' | 'cavitation' | 'seal_failure';
  severity: 'minor' | 'major' | 'catastrophic';
  status: 'running' | 'degraded' | 'failed' | 'tripped';
  performance: {
    flowRate: number;            // 流量 (% of rated)
    head: number;                // 扬程 (% of rated)
    efficiency: number;          // 效率 (%)
    vibration: number;           // 振动 (mm/s)
    temperature: number;         // 温度 (°C)
  };
  faultTime: number;             // 故障时间 (秒)
  recoveryTime: number;          // 恢复时间 (秒)
}

function simulatePumpFault(
  pumpId: string,
  faultType: string,
  currentPerformance: any
): PumpFault {
  const faultEffects = {
    mechanical: {
      flowRate: 0.5,
      head: 0.6,
      efficiency: 0.4,
      vibration: 10,
      temperature: 80
    },
    electrical: {
      flowRate: 0,
      head: 0,
      efficiency: 0,
      vibration: 0,
      temperature: 25
    },
    cavitation: {
      flowRate: 0.7,
      head: 0.5,
      efficiency: 0.3,
      vibration: 15,
      temperature: 60
    },
    seal_failure: {
      flowRate: 0.8,
      head: 0.9,
      efficiency: 0.7,
      vibration: 5,
      temperature: 70
    }
  };
  
  const effects = faultEffects[faultType as keyof typeof faultEffects];
  
  return {
    pumpId,
    faultType: faultType as any,
    severity: 'major',
    status: 'degraded',
    performance: {
      flowRate: currentPerformance.flowRate * effects.flowRate,
      head: currentPerformance.head * effects.head,
      efficiency: currentPerformance.efficiency * effects.efficiency,
      vibration: effects.vibration,
      temperature: effects.temperature
    },
    faultTime: Date.now(),
    recoveryTime: calculateRecoveryTime(faultType)
  };
}
```

**3. 紧急停堆（SCRAM）过程**
```typescript
// 紧急停堆模型
interface ScramProcedure {
  triggerReason: string;
  triggerTime: number;
  scramType: 'automatic' | 'manual' | 'emergency';
  controlRodInsertion: {
    totalRods: number;
    insertedRods: number;
    insertionProgress: number;    // 插入进度 (%)
    estimatedTime: number;        // 预计时间 (秒)
    powerReduction: number;      // 功率降低 (%)
  };
  safetySystems: {
    eccSystem: 'standby' | 'activating' | 'active';
    containmentIsolation: 'normal' | 'isolating' | 'isolated';
    ventilation: 'normal' | 'emergency' | 'filtered';
    electricalBackup: 'normal' | 'battery' | 'generator';
  };
  postScramStatus: {
    reactorStatus: string;
    coreTemperature: number;
    pressure: number;
    waterLevel: number;
    radiationLevel: number;
  };
}

function executeScram(
  triggerReason: string,
  scramType: string,
  currentReactorState: any
): ScramProcedure {
  const triggerTime = Date.now();
  const totalRods = 211;
  const insertionTime = 35; // 秒
  
  return {
    triggerReason,
    triggerTime,
    scramType: scramType as any,
    controlRodInsertion: {
      totalRods,
      insertedRods: 0,
      insertionProgress: 0,
      estimatedTime: insertionTime,
      powerReduction: 0
    },
    safetySystems: {
      eccSystem: 'activating',
      containmentIsolation: 'isolating',
      ventilation: 'filtered',
      electricalBackup: 'normal'
    },
    postScramStatus: {
      reactorStatus: 'SCRAMMING',
      coreTemperature: currentReactorState.core.temperature,
      pressure: currentReactorState.core.pressure,
      waterLevel: currentReactorState.core.waterLevel,
      radiationLevel: currentReactorState.radiation.level
    }
  };
}

function updateScramProgress(scram: ScramProcedure, deltaTime: number): ScramProcedure {
  const progress = deltaTime / scram.controlRodInsertion.estimatedTime;
  const newProgress = Math.min(scram.controlRodInsertion.insertionProgress + progress, 1.0);
  
  // 石墨尖端效应：前20%插入时功率短暂增加
  let powerMultiplier = 1.0;
  if (newProgress < 0.2) {
    powerMultiplier = 1 + Math.sin(newProgress * Math.PI / 0.2) * 0.1;
  }
  
  // 主要吸收效应
  const absorptionEffect = newProgress * 0.9;
  powerMultiplier *= (1 - absorptionEffect);
  
  return {
    ...scram,
    controlRodInsertion: {
      ...scram.controlRodInsertion,
      insertedRods: Math.floor(scram.controlRodInsertion.totalRods * newProgress),
      insertionProgress: newProgress,
      powerReduction: (1 - powerMultiplier) * 100
    }
  };
}
```

### 2.3 参数真实性详细校准

#### 2.3.1 反应堆核心参数

**真实RBMK-1000参数范围**：
```typescript
// 反应堆核心参数校准
interface ReactorCoreParameters {
  // 温度参数
  temperature: {
    normalOperating: { min: 280; max: 320; unit: '°C' };
    alarm: { high: 330; critical: 350; unit: '°C' };
    scram: { temperature: 360; unit: '°C' };
  };
  
  // 压力参数
  pressure: {
    normalOperating: { min: 6.0; max: 7.5; unit: 'MPa' };
    alarm: { high: 7.8; critical: 8.0; unit: 'MPa' };
    scram: { pressure: 8.5; unit: 'MPa' };
  };
  
  // 水位参数
  waterLevel: {
    normalOperating: { min: 65; max: 75; unit: '%' };
    alarm: { high: 85; low: 55; unit: '%' };
    scram: { high: 90; low: 45; unit: '%' };
  };
  
  // 功率参数
  power: {
    normalOperating: { min: 0; max: 100; unit: '%' };
    alarm: { high: 105; unit: '%' };
    scram: { power: 120; unit: '%' };
  };
  
  // 中子参数
  neutron: {
    flux: {
      normalOperating: { min: 1e13; max: 3e14; unit: 'n/cm²/s' };
      scram: { flux: 5e14; unit: 'n/cm²/s' };
    };
    rate: {
      normalOperating: { min: -10; max: 10; unit: '%/s' };
      scram: { rate: 20; unit: '%/s' };
    };
  };
}

const REACTOR_CORE_PARAMETERS: ReactorCoreParameters = {
  temperature: {
    normalOperating: { min: 280, max: 320, unit: '°C' },
    alarm: { high: 330, critical: 350, unit: '°C' },
    scram: { temperature: 360, unit: '°C' }
  },
  pressure: {
    normalOperating: { min: 6.0, max: 7.5, unit: 'MPa' },
    alarm: { high: 7.8, critical: 8.0, unit: 'MPa' },
    scram: { pressure: 8.5, unit: 'MPa' }
  },
  waterLevel: {
    normalOperating: { min: 65, max: 75, unit: '%' },
    alarm: { high: 85, low: 55, unit: '%' },
    scram: { high: 90, low: 45, unit: '%' }
  },
  power: {
    normalOperating: { min: 0, max: 100, unit: '%' },
    alarm: { high: 105, unit: '%' },
    scram: { power: 120, unit: '%' }
  },
  neutron: {
    flux: {
      normalOperating: { min: 1e13, max: 3e14, unit: 'n/cm²/s' },
      scram: { flux: 5e14, unit: 'n/cm²/s' }
    },
    rate: {
      normalOperating: { min: -10, max: 10, unit: '%/s' },
      scram: { rate: 20, unit: '%/s' }
    }
  }
};
```

#### 2.3.2 汽轮机参数

**真实汽轮机参数范围**：
```typescript
// 汽轮机参数校准
interface TurbineParameters {
  // 转速参数
  speed: {
    normalOperating: { min: 3580; max: 3620; unit: 'RPM' };
    alarm: { high: 3650; low: 3550; unit: 'RPM' };
    trip: { overspeed: 3960; unit: 'RPM' };
  };
  
  // 振动参数
  vibration: {
    normalOperating: { max: 0.05; unit: 'mm/s' };
    alarm: { high: 0.08; unit: 'mm/s' };
    trip: { vibration: 0.12; unit: 'mm/s' };
  };
  
  // 差胀参数
  differentialExpansion: {
    normalOperating: { min: -2; max: 2; unit: 'mm' };
    alarm: { high: 3; low: -3; unit: 'mm' };
    trip: { high: 4; low: -4; unit: 'mm' };
  };
  
  // 负荷参数
  load: {
    normalOperating: { min: 0; max: 1000; unit: 'MW' };
    rampRate: { max: 10; unit: 'MW/min' };
  };
  
  // 蒸汽参数
  steam: {
    inletPressure: {
      normalOperating: { min: 6.0; max: 7.5; unit: 'MPa' };
      alarm: { high: 7.8; unit: 'MPa' };
    };
    inletTemperature: {
      normalOperating: { min: 270; max: 290; unit: '°C' };
      alarm: { high: 300; unit: '°C' };
    };
    exhaustPressure: {
      normalOperating: { max: 0.01; unit: 'MPa' };
      alarm: { high: 0.02; unit: 'MPa' };
    };
  };
}

const TURBINE_PARAMETERS: TurbineParameters = {
  speed: {
    normalOperating: { min: 3580, max: 3620, unit: 'RPM' },
    alarm: { high: 3650, low: 3550, unit: 'RPM' },
    trip: { overspeed: 3960, unit: 'RPM' }
  },
  vibration: {
    normalOperating: { max: 0.05, unit: 'mm/s' },
    alarm: { high: 0.08, unit: 'mm/s' },
    trip: { vibration: 0.12, unit: 'mm/s' }
  },
  differentialExpansion: {
    normalOperating: { min: -2, max: 2, unit: 'mm' },
    alarm: { high: 3, low: -3, unit: 'mm' },
    trip: { high: 4, low: -4, unit: 'mm' }
  },
  load: {
    normalOperating: { min: 0, max: 1000, unit: 'MW' },
    rampRate: { max: 10, unit: 'MW/min' }
  },
  steam: {
    inletPressure: {
      normalOperating: { min: 6.0, max: 7.5, unit: 'MPa' },
      alarm: { high: 7.8, unit: 'MPa' }
    },
    inletTemperature: {
      normalOperating: { min: 270, max: 290, unit: '°C' },
      alarm: { high: 300, unit: '°C' }
    },
    exhaustPressure: {
      normalOperating: { max: 0.01, unit: 'MPa' },
      alarm: { high: 0.02, unit: 'MPa' }
    }
  }
};
```

#### 2.3.3 辅助系统参数

**真实辅助系统参数范围**：
```typescript
// 辅助系统参数校准
interface AuxiliarySystemParameters {
  // 凝汽器参数
  condenser: {
    vacuum: {
      normalOperating: { min: 95; max: 99; unit: '%' };
      alarm: { low: 90; unit: '%' };
      trip: { vacuum: 85; unit: '%' };
    };
    hotwellLevel: {
      normalOperating: { min: -1; max: 1; unit: 'inches' };
      alarm: { high: 3; low: -3; unit: 'inches' };
    };
    coolingWater: {
      temperature: {
        inlet: { normal: 25; max: 35; unit: '°C' };
        outlet: { normal: 35; max: 45; unit: '°C' };
      };
      flow: {
        normalOperating: { min: 400000; max: 600000; unit: 'GPM' };
        alarm: { low: 350000; unit: 'GPM' };
      };
    };
  };
  
  // 除氧器参数
  deaerator: {
    pressure: {
      normalOperating: { min: 0.11; max: 0.17; unit: 'MPa' };
      alarm: { high: 0.18; low: 0.10; unit: 'MPa' };
    };
    level: {
      normalOperating: { min: -1; max: 1; unit: 'inches' };
      alarm: { high: 3; low: -3; unit: 'inches' };
    };
    temperature: {
      normalOperating: { min: 100; max: 120; unit: '°C' };
      alarm: { high: 125; unit: '°C' };
    };
  };
  
  // 给水泵参数
  feedwaterPump: {
    dischargePressure: {
      normalOperating: { min: 7.5; max: 9.0; unit: 'MPa' };
      alarm: { low: 7.0; unit: 'MPa' };
    };
    flow: {
      normalOperating: { min: 50000; max: 80000; unit: 'kg/h' };
      alarm: { low: 45000; unit: 'kg/h' };
    };
    vibration: {
      normalOperating: { max: 0.05; unit: 'mm/s' };
      alarm: { high: 0.08; unit: 'mm/s' };
    };
  };
  
  // 应急冷却系统参数
  emergencyCooling: {
    pumpFlow: {
      required: { min: 8500000; unit: 'lb/h' };
      actual: { current: number; unit: 'lb/h' };
    };
    activationTime: {
      automatic: { max: 5; unit: 'seconds' };
      manual: { max: 10; unit: 'seconds' };
    };
  };
}

const AUXILIARY_SYSTEM_PARAMETERS: AuxiliarySystemParameters = {
  condenser: {
    vacuum: {
      normalOperating: { min: 95, max: 99, unit: '%' },
      alarm: { low: 90, unit: '%' },
      trip: { vacuum: 85, unit: '%' }
    },
    hotwellLevel: {
      normalOperating: { min: -1, max: 1, unit: 'inches' },
      alarm: { high: 3, low: -3, unit: 'inches' }
    },
    coolingWater: {
      temperature: {
        inlet: { normal: 25, max: 35, unit: '°C' },
        outlet: { normal: 35, max: 45, unit: '°C' }
      },
      flow: {
        normalOperating: { min: 400000, max: 600000, unit: 'GPM' },
        alarm: { low: 350000, unit: 'GPM' }
      }
    }
  },
  deaerator: {
    pressure: {
      normalOperating: { min: 0.11, max: 0.17, unit: 'MPa' },
      alarm: { high: 0.18, low: 0.10, unit: 'MPa' }
    },
    level: {
      normalOperating: { min: -1, max: 1, unit: 'inches' },
      alarm: { high: 3, low: -3, unit: 'inches' }
    },
    temperature: {
      normalOperating: { min: 100, max: 120, unit: '°C' },
      alarm: { high: 125, unit: '°C' }
    }
  },
  feedwaterPump: {
    dischargePressure: {
      normalOperating: { min: 7.5, max: 9.0, unit: 'MPa' },
      alarm: { low: 7.0, unit: 'MPa' }
    },
    flow: {
      normalOperating: { min: 50000, max: 80000, unit: 'kg/h' },
      alarm: { low: 45000, unit: 'kg/h' }
    },
    vibration: {
      normalOperating: { max: 0.05, unit: 'mm/s' },
      alarm: { high: 0.08, unit: 'mm/s' }
    }
  },
  emergencyCooling: {
    pumpFlow: {
      required: { min: 8500000, unit: 'lb/h' },
      actual: { current: 0, unit: 'lb/h' }
    },
    activationTime: {
      automatic: { max: 5, unit: 'seconds' },
      manual: { max: 10, unit: 'seconds' }
    }
  }
};
```

#### 2.3.4 响应时间校准

**真实系统响应时间**：
```typescript
// 系统响应时间校准
interface SystemResponseTimes {
  // 控制棒响应
  controlRods: {
    insertionSpeed: { min: 0.5; max: 1.0; unit: 'cm/s' };
    fullInsertionTime: { min: 30; max: 45; unit: 'seconds' };
    withdrawalSpeed: { min: 0.5; max: 1.0; unit: 'cm/s' };
  };
  
  // 泵响应
  pumps: {
    startupTime: { normal: 7; max: 15; unit: 'seconds' };
    tripTime: { max: 2; unit: 'seconds' };
    flowChangeTime: { max: 10; unit: 'seconds' };
  };
  
  // 阀门响应
  valves: {
    small: { openCloseTime: { min: 1; max: 3; unit: 'seconds' } };
    medium: { openCloseTime: { min: 3; max: 10; unit: 'seconds' } };
    large: { openCloseTime: { min: 10; max: 30; unit: 'seconds' } };
    emergency: { openCloseTime: { max: 1; unit: 'seconds' } };
  };
  
  // 温度响应
  temperature: {
    coreResponse: { timeConstant: 300; unit: 'seconds' };
    coolantResponse: { timeConstant: 60; unit: 'seconds' };
    steamResponse: { timeConstant: 30; unit: 'seconds' };
  };
  
  // 压力响应
  pressure: {
    primarySystem: { timeConstant: 120; unit: 'seconds' };
    secondarySystem: { timeConstant: 60; unit: 'seconds' };
    condenserVacuum: { timeConstant: 180; unit: 'seconds' };
  };
  
  // 水位响应
  waterLevel: {
    reactorCore: { timeConstant: 90; unit: 'seconds' };
    deaerator: { timeConstant: 60; unit: 'seconds' };
    hotwell: { timeConstant: 30; unit: 'seconds' };
  };
  
  // 涡轮机响应
  turbine: {
    speedChange: { rampRate: { max: 100; unit: 'RPM/min' } };
    loadChange: { rampRate: { max: 10; unit: 'MW/min' } };
    coastDown: { maxTime: 7200; unit: 'seconds' }; // 2小时
  };
}

const SYSTEM_RESPONSE_TIMES: SystemResponseTimes = {
  controlRods: {
    insertionSpeed: { min: 0.5, max: 1.0, unit: 'cm/s' },
    fullInsertionTime: { min: 30, max: 45, unit: 'seconds' },
    withdrawalSpeed: { min: 0.5, max: 1.0, unit: 'cm/s' }
  },
  pumps: {
    startupTime: { normal: 7, max: 15, unit: 'seconds' },
    tripTime: { max: 2, unit: 'seconds' },
    flowChangeTime: { max: 10, unit: 'seconds' }
  },
  valves: {
    small: { openCloseTime: { min: 1, max: 3, unit: 'seconds' } },
    medium: { openCloseTime: { min: 3, max: 10, unit: 'seconds' } },
    large: { openCloseTime: { min: 10, max: 30, unit: 'seconds' } },
    emergency: { openCloseTime: { max: 1, unit: 'seconds' } }
  },
  temperature: {
    coreResponse: { timeConstant: 300, unit: 'seconds' },
    coolantResponse: { timeConstant: 60, unit: 'seconds' },
    steamResponse: { timeConstant: 30, unit: 'seconds' }
  },
  pressure: {
    primarySystem: { timeConstant: 120, unit: 'seconds' },
    secondarySystem: { timeConstant: 60, unit: 'seconds' },
    condenserVacuum: { timeConstant: 180, unit: 'seconds' }
  },
  waterLevel: {
    reactorCore: { timeConstant: 90, unit: 'seconds' },
    deaerator: { timeConstant: 60, unit: 'seconds' },
    hotwell: { timeConstant: 30, unit: 'seconds' }
  },
  turbine: {
    speedChange: { rampRate: { max: 100, unit: 'RPM/min' } },
    loadChange: { rampRate: { max: 10, unit: 'MW/min' } },
    coastDown: { maxTime: 7200, unit: 'seconds' }
  }
};
```

## 三、面板控制选项详细优化

### 3.1 UI/UX深度优化

#### 3.1.1 实现多视图模式

**1. 单个系统详细视图**
```typescript
// 单个系统详细视图配置
interface SingleSystemDetailView {
  systemId: string;
  systemName: string;
  components: {
    id: string;
    name: string;
    type: 'pump' | 'valve' | 'heat_exchanger' | 'tank' | 'sensor';
    status: 'normal' | 'warning' | 'alarm' | 'offline';
    parameters: {
      name: string;
      value: number;
      unit: string;
      min: number;
      max: number;
      alarm: { high: number; low: number };
    }[];
    controls: {
      type: 'button' | 'slider' | 'toggle' | 'input';
      label: string;
      currentValue: any;
      range?: [number, number];
      options?: string[];
    }[];
  }[];
  alarms: {
    id: string;
    message: string;
    severity: 'info' | 'warning' | 'critical';
    timestamp: number;
    acknowledged: boolean;
  }[];
  trends: {
    parameterId: string;
    data: { time: number; value: number }[];
    timeRange: number;
  }[];
}

// 示例：反应堆给水泵详细视图
const reactorFeedPumpDetailView: SingleSystemDetailView = {
  systemId: 'reactor_feed_pump_1',
  systemName: '反应堆给水泵 #1',
  components: [
    {
      id: 'pump_1',
      name: '主给水泵',
      type: 'pump',
      status: 'normal',
      parameters: [
        { name: '流量', value: 65000, unit: 'kg/h', min: 0, max: 80000, alarm: { high: 75000, low: 45000 } },
        { name: '排放压力', value: 8.2, unit: 'MPa', min: 0, max: 10, alarm: { high: 9.0, low: 7.0 } },
        { name: '振动', value: 0.03, unit: 'mm/s', min: 0, max: 0.1, alarm: { high: 0.08, low: 0 } },
        { name: '轴承温度', value: 65, unit: '°C', min: 20, max: 90, alarm: { high: 80, low: 30 } }
      ],
      controls: [
        { type: 'button', label: '启动', currentValue: false },
        { type: 'button', label: '停止', currentValue: false },
        { type: 'slider', label: '流量设定', currentValue: 65000, range: [0, 80000] }
      ]
    },
    {
      id: 'inlet_valve_1',
      name: '入口阀',
      type: 'valve',
      status: 'normal',
      parameters: [
        { name: '阀门位置', value: 100, unit: '%', min: 0, max: 100, alarm: { high: 100, low: 0 } },
        { name: '上游压力', value: 0.5, unit: 'MPa', min: 0, max: 1, alarm: { high: 0.8, low: 0.3 } }
      ],
      controls: [
        { type: 'toggle', label: '打开/关闭', currentValue: true },
        { type: 'slider', label: '阀门位置', currentValue: 100, range: [0, 100] }
      ]
    },
    {
      id: 'outlet_valve_1',
      name: '出口阀',
      type: 'valve',
      status: 'normal',
      parameters: [
        { name: '阀门位置', value: 85, unit: '%', min: 0, max: 100, alarm: { high: 100, low: 0 } },
        { name: '下游压力', value: 8.2, unit: 'MPa', min: 0, max: 10, alarm: { high: 9.0, low: 7.0 } }
      ],
      controls: [
        { type: 'toggle', label: '打开/关闭', currentValue: true },
        { type: 'slider', label: '阀门位置', currentValue: 85, range: [0, 100] }
      ]
    }
  ],
  alarms: [],
  trends: [
    {
      parameterId: 'flow_rate',
      data: [],
      timeRange: 3600 // 1小时
    }
  ]
};
```

**2. 系统集成概览视图**
```typescript
// 系统集成概览视图配置
interface IntegratedOverviewView {
  layout: 'grid' | 'schematic' | 'hierarchical';
  systems: {
    id: string;
    name: string;
    status: 'normal' | 'warning' | 'alarm' | 'offline';
    position: { x: number; y: number };
    connections: {
      to: string;
      type: 'flow' | 'signal' | 'control';
      direction: 'bidirectional' | 'unidirectional';
      status: 'normal' | 'warning' | 'alarm';
    }[];
    keyParameters: {
      name: string;
      value: number;
      unit: string;
      status: 'normal' | 'warning' | 'alarm';
    }[];
  }[];
  globalStatus: {
    overall: 'normal' | 'warning' | 'alarm';
    powerOutput: number;
    efficiency: number;
    safetyMargin: number;
  };
}

// 示例：切尔诺贝利电站概览视图
const chernobylPlantOverview: IntegratedOverviewView = {
  layout: 'schematic',
  systems: [
    {
      id: 'reactor_core',
      name: '反应堆堆芯',
      status: 'normal',
      position: { x: 400, y: 200 },
      connections: [
        { to: 'steam_drum', type: 'flow', direction: 'unidirectional', status: 'normal' },
        { to: 'recirculation_pumps', type: 'flow', direction: 'bidirectional', status: 'normal' }
      ],
      keyParameters: [
        { name: '热功率', value: 2800, unit: 'MW', status: 'normal' },
        { name: '堆芯温度', value: 295, unit: '°C', status: 'normal' },
        { name: '水位', value: 70, unit: '%', status: 'normal' }
      ]
    },
    {
      id: 'steam_drum',
      name: '蒸汽鼓',
      status: 'normal',
      position: { x: 400, y: 100 },
      connections: [
        { to: 'reactor_core', type: 'flow', direction: 'unidirectional', status: 'normal' },
        { to: 'turbine', type: 'flow', direction: 'unidirectional', status: 'normal' }
      ],
      keyParameters: [
        { name: '压力', value: 6.8, unit: 'MPa', status: 'normal' },
        { name: '水位', value: 0, unit: 'inches', status: 'normal' }
      ]
    },
    {
      id: 'turbine',
      name: '汽轮机',
      status: 'normal',
      position: { x: 600, y: 100 },
      connections: [
        { to: 'steam_drum', type: 'flow', direction: 'unidirectional', status: 'normal' },
        { to: 'generator', type: 'mechanical', direction: 'unidirectional', status: 'normal' },
        { to: 'condenser', type: 'flow', direction: 'unidirectional', status: 'normal' }
      ],
      keyParameters: [
        { name: '转速', value: 3600, unit: 'RPM', status: 'normal' },
        { name: '负荷', value: 950, unit: 'MW', status: 'normal' },
        { name: '振动', value: 0.03, unit: 'mm/s', status: 'normal' }
      ]
    },
    {
      id: 'generator',
      name: '发电机',
      status: 'normal',
      position: { x: 800, y: 100 },
      connections: [
        { to: 'turbine', type: 'mechanical', direction: 'unidirectional', status: 'normal' },
        { to: 'grid', type: 'electrical', direction: 'bidirectional', status: 'normal' }
      ],
      keyParameters: [
        { name: '输出功率', value: 950, unit: 'MW', status: 'normal' },
        { name: '电压', value: 22000, unit: 'V', status: 'normal' },
        { name: '频率', value: 60, unit: 'Hz', status: 'normal' }
      ]
    },
    {
      id: 'condenser',
      name: '凝汽器',
      status: 'normal',
      position: { x: 600, y: 300 },
      connections: [
        { to: 'turbine', type: 'flow', direction: 'unidirectional', status: 'normal' },
        { to: 'hotwell', type: 'flow', direction: 'unidirectional', status: 'normal' },
        { to: 'cooling_tower', type: 'flow', direction: 'bidirectional', status: 'normal' }
      ],
      keyParameters: [
        { name: '真空度', value: 97, unit: '%', status: 'normal' },
        { name: '热井水位', value: 0, unit: 'inches', status: 'normal' },
        { name: '冷却水温度', value: 35, unit: '°C', status: 'normal' }
      ]
    },
    {
      id: 'hotwell',
      name: '热井',
      status: 'normal',
      position: { x: 600, y: 400 },
      connections: [
        { to: 'condenser', type: 'flow', direction: 'unidirectional', status: 'normal' },
        { to: 'condensate_pumps', type: 'flow', direction: 'unidirectional', status: 'normal' }
      ],
      keyParameters: [
        { name: '水位', value: 0, unit: 'inches', status: 'normal' },
        { name: '温度', value: 35, unit: '°C', status: 'normal' }
      ]
    },
    {
      id: 'deaerator',
      name: '除氧器',
      status: 'normal',
      position: { x: 200, y: 300 },
      connections: [
        { to: 'condensate_pumps', type: 'flow', direction: 'unidirectional', status: 'normal' },
        { to: 'feedwater_pumps', type: 'flow', direction: 'unidirectional', status: 'normal' }
      ],
      keyParameters: [
        { name: '压力', value: 0.14, unit: 'MPa', status: 'normal' },
        { name: '水位', value: 0, unit: 'inches', status: 'normal' },
        { name: '温度', value: 110, unit: '°C', status: 'normal' }
      ]
    }
  ],
  globalStatus: {
    overall: 'normal',
    powerOutput: 950,
    efficiency: 32.5,
    safetyMargin: 85
  }
};
```

**3. 关键参数监控仪表板**
```typescript
// 关键参数监控仪表板
interface KeyParametersDashboard {
  layout: 'compact' | 'detailed' | 'hierarchical';
  parameters: {
    category: 'reactor' | 'turbine' | 'auxiliary' | 'electrical';
    items: {
      id: string;
      name: string;
      value: number;
      unit: string;
      setpoint: number;
      tolerance: number;
      status: 'normal' | 'warning' | 'alarm';
      trend: 'increasing' | 'decreasing' | 'stable';
      history: { time: number; value: number }[];
    }[];
  }[];
  alerts: {
    id: string;
    message: string;
    severity: 'info' | 'warning' | 'critical';
    timestamp: number;
    acknowledged: boolean;
  }[];
}

// 示例：关键参数仪表板
const keyParametersDashboard: KeyParametersDashboard = {
  layout: 'detailed',
  parameters: [
    {
      category: 'reactor',
      items: [
        {
          id: 'reactor_power',
          name: '反应堆功率',
          value: 2800,
          unit: 'MW',
          setpoint: 2800,
          tolerance: 50,
          status: 'normal',
          trend: 'stable',
          history: []
        },
        {
          id: 'core_temperature',
          name: '堆芯温度',
          value: 295,
          unit: '°C',
          setpoint: 300,
          tolerance: 10,
          status: 'normal',
          trend: 'stable',
          history: []
        },
        {
          id: 'reactor_pressure',
          name: '反应堆压力',
          value: 6.8,
          unit: 'MPa',
          setpoint: 7.0,
          tolerance: 0.2,
          status: 'normal',
          trend: 'stable',
          history: []
        },
        {
          id: 'reactor_water_level',
          name: '反应堆水位',
          value: 70,
          unit: '%',
          setpoint: 70,
          tolerance: 5,
          status: 'normal',
          trend: 'stable',
          history: []
        }
      ]
    },
    {
      category: 'turbine',
      items: [
        {
          id: 'turbine_speed',
          name: '汽轮机转速',
          value: 3600,
          unit: 'RPM',
          setpoint: 3600,
          tolerance: 20,
          status: 'normal',
          trend: 'stable',
          history: []
        },
        {
          id: 'turbine_load',
          name: '汽轮机负荷',
          value: 950,
          unit: 'MW',
          setpoint: 950,
          tolerance: 20,
          status: 'normal',
          trend: 'stable',
          history: []
        },
        {
          id: 'turbine_vibration',
          name: '汽轮机振动',
          value: 0.03,
          unit: 'mm/s',
          setpoint: 0.02,
          tolerance: 0.02,
          status: 'normal',
          trend: 'stable',
          history: []
        }
      ]
    }
  ],
  alerts: []
};
```

#### 3.1.2 增强视觉反馈

**1. 参数变化趋势指示器**
```typescript
// 参数变化趋势指示器
interface TrendIndicator {
  parameterId: string;
  currentValue: number;
  previousValue: number;
  trend: 'increasing' | 'decreasing' | 'stable';
  rateOfChange: number;
  prediction: {
    shortTerm: number;      // 短期预测（5分钟）
    mediumTerm: number;     // 中期预测（30分钟）
    longTerm: number;       // 长期预测（2小时）
  };
  confidence: number;      // 预测置信度 (0-1)
}

function calculateTrendIndicator(
  history: { time: number; value: number }[],
  currentValue: number
): TrendIndicator {
  if (history.length < 2) {
    return {
      parameterId: '',
      currentValue,
      previousValue: currentValue,
      trend: 'stable',
      rateOfChange: 0,
      prediction: { shortTerm: currentValue, mediumTerm: currentValue, longTerm: currentValue },
      confidence: 0
    };
  }
  
  const previousValue = history[history.length - 1].value;
  const rateOfChange = currentValue - previousValue;
  
  // 计算趋势
  let trend: 'increasing' | 'decreasing' | 'stable';
  if (Math.abs(rateOfChange) < 0.01) {
    trend = 'stable';
  } else if (rateOfChange > 0) {
    trend = 'increasing';
  } else {
    trend = 'decreasing';
  }
  
  // 简单线性预测
  const shortTermPrediction = currentValue + rateOfChange * 5;
  const mediumTermPrediction = currentValue + rateOfChange * 30;
  const longTermPrediction = currentValue + rateOfChange * 120;
  
  // 计算置信度（基于历史数据的一致性）
  const variance = calculateVariance(history);
  const confidence = Math.max(0, 1 - variance / Math.abs(currentValue));
  
  return {
    parameterId: '',
    currentValue,
    previousValue,
    trend,
    rateOfChange,
    prediction: {
      shortTerm: shortTermPrediction,
      mediumTerm: mediumTermPrediction,
      longTerm: longTermPrediction
    },
    confidence
  };
}
```

**2. 声光警报系统**
```typescript
// 声光警报系统
interface AlarmSystem {
  visual: {
    color: 'green' | 'yellow' | 'orange' | 'red';
    flashing: boolean;
    flashRate: number;         // 闪烁频率 (Hz)
    pattern: 'steady' | 'slow' | 'fast' | 'emergency';
  };
  audio: {
    enabled: boolean;
    soundType: 'beep' | 'alarm' | 'siren' | 'voice';
    volume: number;            // 音量 (0-100%)
    frequency: number;         // 频率 (Hz)
    pattern: 'continuous' | 'intermittent' | 'pulsed';
  };
  haptic: {
    enabled: boolean;
    intensity: number;         // 强度 (0-100%)
    pattern: 'continuous' | 'intermittent';
  };
}

function configureAlarm(alarmLevel: 'info' | 'warning' | 'critical'): AlarmSystem {
  switch (alarmLevel) {
    case 'info':
      return {
        visual: {
          color: 'green',
          flashing: false,
          flashRate: 0,
          pattern: 'steady'
        },
        audio: {
          enabled: true,
          soundType: 'beep',
          volume: 30,
          frequency: 440,
          pattern: 'intermittent'
        },
        haptic: {
          enabled: false,
          intensity: 0,
          pattern: 'continuous'
        }
      };
    case 'warning':
      return {
        visual: {
          color: 'yellow',
          flashing: true,
          flashRate: 1,
          pattern: 'slow'
        },
        audio: {
          enabled: true,
          soundType: 'alarm',
          volume: 60,
          frequency: 880,
          pattern: 'intermittent'
        },
        haptic: {
          enabled: true,
          intensity: 50,
          pattern: 'intermittent'
        }
      };
    case 'critical':
      return {
        visual: {
          color: 'red',
          flashing: true,
          flashRate: 3,
          pattern: 'emergency'
        },
        audio: {
          enabled: true,
          soundType: 'siren',
          volume: 100,
          frequency: 1200,
          pattern: 'pulsed'
        },
        haptic: {
          enabled: true,
          intensity: 100,
          pattern: 'pulsed'
        }
      };
    default:
      return {
        visual: {
          color: 'green',
          flashing: false,
          flashRate: 0,
          pattern: 'steady'
        },
        audio: {
          enabled: false,
          soundType: 'beep',
          volume: 0,
          frequency: 0,
          pattern: 'continuous'
        },
        haptic: {
          enabled: false,
          intensity: 0,
          pattern: 'continuous'
        }
      };
  }
}
```

**3. 颜色编码状态系统**
```typescript
// 颜色编码状态系统
interface ColorCodingSystem {
  statusColors: {
    normal: {
      primary: '#00bcd4';      // 青色
      secondary: '#4caf50';    // 绿色
      background: '#1e1e1e';    // 深灰
      text: '#e0e0e0';         // 浅灰
    };
    warning: {
      primary: '#ff9800';      // 橙色
      secondary: '#ffc107';     // 黄色
      background: '#2d2d00';    // 深黄
      text: '#fff9c4';         // 浅黄
    };
    alarm: {
      primary: '#f44336';      // 红色
      secondary: '#e53935';     // 深红
      background: '#2d0000';    // 深红
      text: '#ffcdd2';         // 浅红
    };
    critical: {
      primary: '#d32f2f';      // 暗红
      secondary: '#b71c1c';    // 深红
      background: '#1a0000';    // 深红
      text: '#ef9a9a';         // 浅红
    };
    offline: {
      primary: '#9e9e9e';      // 灰色
      secondary: '#757575';    // 深灰
      background: '#212121';    // 深灰
      text: '#bdbdbd';         // 浅灰
    };
  };
  parameterColors: {
    temperature: '#ff5722';    // 温度-橙色
    pressure: '#2196f3';       // 压力-蓝色
    flow: '#4caf50';           // 流量-绿色
    level: '#9c27b0';          // 水位-紫色
    power: '#ff9800';          // 功率-橙色
    vibration: '#f44336';      // 振动-红色
    efficiency: '#00bcd4';     // 效率-青色
  };
}

const COLOR_CODING_SYSTEM: ColorCodingSystem = {
  statusColors: {
    normal: {
      primary: '#00bcd4',
      secondary: '#4caf50',
      background: '#1e1e1e',
      text: '#e0e0e0'
    },
    warning: {
      primary: '#ff9800',
      secondary: '#ffc107',
      background: '#2d2d00',
      text: '#fff9c4'
    },
    alarm: {
      primary: '#f44336',
      secondary: '#e53935',
      background: '#2d0000',
      text: '#ffcdd2'
    },
    critical: {
      primary: '#d32f2f',
      secondary: '#b71c1c',
      background: '#1a0000',
      text: '#ef9a9a'
    },
    offline: {
      primary: '#9e9e9e',
      secondary: '#757575',
      background: '#212121',
      text: '#bdbdbd'
    }
  },
  parameterColors: {
    temperature: '#ff5722',
    pressure: '#2196f3',
    flow: '#4caf50',
    level: '#9c27b0',
    power: '#ff9800',
    vibration: '#f44336',
    efficiency: '#00bcd4'
  }
};
```

#### 3.1.3 改进操作界面

**1. 操作确认机制**
```typescript
// 操作确认机制
interface OperationConfirmation {
  operationId: string;
  operationType: 'startup' | 'shutdown' | 'scram' | 'parameter_change' | 'valve_operation';
  description: string;
  riskLevel: 'low' | 'medium' | 'high' | 'critical';
  consequences: string[];
  prerequisites: string[];
  confirmationRequired: boolean;
  authorizationLevel: 'operator' | 'supervisor' | 'engineer' | 'manager';
  timeout: number;             // 超时时间 (秒)
  doubleConfirmation: boolean;  // 需要双重确认
  logEntry: {
    timestamp: number;
    operator: string;
    operation: string;
    result: 'approved' | 'rejected' | 'cancelled';
  };
}

function requestOperationConfirmation(
  operation: string,
  riskLevel: string,
  consequences: string[]
): OperationConfirmation {
  const confirmationRequired = riskLevel !== 'low';
  const doubleConfirmation = riskLevel === 'critical';
  
  return {
    operationId: generateOperationId(),
    operationType: 'parameter_change',
    description: operation,
    riskLevel: riskLevel as any,
    consequences,
    prerequisites: [],
    confirmationRequired,
    authorizationLevel: riskLevel === 'critical' ? 'supervisor' : 'operator',
    timeout: riskLevel === 'critical' ? 30 : 60,
    doubleConfirmation,
    logEntry: {
      timestamp: Date.now(),
      operator: '',
      operation,
      result: 'approved'
    }
  };
}
```

**2. 操作日志和历史记录**
```typescript
// 操作日志系统
interface OperationLogSystem {
  logs: {
    id: string;
    timestamp: number;
    operator: string;
    operation: string;
    parameters: {
      name: string;
      oldValue: any;
      newValue: any;
    }[];
    result: 'success' | 'failure' | 'cancelled';
    duration: number;          // 操作持续时间 (毫秒)
    affectedSystems: string[];
    alarmsTriggered: string[];
  }[];
  filters: {
    timeRange: { start: number; end: number };
    operators: string[];
    operationTypes: string[];
    systems: string[];
    results: string[];
  };
  export: {
    format: 'json' | 'csv' | 'xml' | 'pdf';
    includeDetails: boolean;
    includeTrends: boolean;
  };
}

function addOperationLog(
  operator: string,
  operation: string,
  parameters: { name: string; oldValue: any; newValue: any }[],
  result: string,
  duration: number
): void {
  const logEntry = {
    id: generateLogId(),
    timestamp: Date.now(),
    operator,
    operation,
    parameters,
    result: result as any,
    duration,
    affectedSystems: [],
    alarmsTriggered: []
  };
  
  // 添加到日志系统
  operationLogSystem.logs.push(logEntry);
  
  // 限制日志数量
  if (operationLogSystem.logs.length > 10000) {
    operationLogSystem.logs.shift();
  }
}
```

**3. 快捷操作面板**
```typescript
// 快捷操作面板
interface QuickActionPanel {
  actions: {
    id: string;
    name: string;
    icon: string;
    category: 'startup' | 'shutdown' | 'emergency' | 'routine';
    shortcut: string;
    riskLevel: 'low' | 'medium' | 'high' | 'critical';
    frequency: number;          // 使用频率
    lastUsed: number;           // 最后使用时间
    enabled: boolean;
  }[];
  layout: 'grid' | 'list' | 'custom';
  customization: {
    userDefinedActions: string[];
    hiddenActions: string[];
    pinnedActions: string[];
  };
}

const QUICK_ACTION_PANEL: QuickActionPanel = {
  actions: [
    {
      id: 'scram',
      name: '紧急停堆',
      icon: '⚠️',
      category: 'emergency',
      shortcut: 'Ctrl+Shift+S',
      riskLevel: 'critical',
      frequency: 0,
      lastUsed: 0,
      enabled: true
    },
    {
      id: 'start_turbine',
      name: '启动汽轮机',
      icon: '🔄',
      category: 'startup',
      shortcut: 'Ctrl+T',
      riskLevel: 'medium',
      frequency: 5,
      lastUsed: Date.now() - 3600000,
      enabled: true
    },
    {
      id: 'emergency_cooling',
      name: '应急冷却',
      icon: '❄️',
      category: 'emergency',
      shortcut: 'Ctrl+E',
      riskLevel: 'high',
      frequency: 1,
      lastUsed: Date.now() - 86400000,
      enabled: true
    },
    {
      id: 'normal_shutdown',
      name: '正常停机',
      icon: '🛑',
      category: 'shutdown',
      shortcut: 'Ctrl+D',
      riskLevel: 'medium',
      frequency: 2,
      lastUsed: Date.now() - 172800000,
      enabled: true
    }
  ],
  layout: 'grid',
  customization: {
    userDefinedActions: [],
    hiddenActions: [],
    pinnedActions: ['scram', 'emergency_cooling']
  }
};
```

## 四、技术实现详细方案

### 4.1 核心架构优化

**建议采用模块化架构**：
```
src/
├── models/                      # 物理模型
│   ├── thermal-hydraulic/       # 热工水力模型
│   │   ├── MassBalance.ts
│   │   ├── EnergyBalance.ts
│   │   ├── FlowResistance.ts
│   │   └── WaterSteamProperties.ts
│   ├── neutron/                 # 中子物理模型
│   │   ├── VoidCoefficient.ts
│   │   ├── XenonPoisoning.ts
│   │   └── ControlRodPhysics.ts
│   └── systems/                # 各系统模型
│       ├── ReactorCore.ts
│       ├── Turbine.ts
│       ├── Condenser.ts
│       └── Deaerator.ts
├── stores/                     # 状态管理
│   ├── reactorStore.ts          # 主状态
│   ├── subsystems/             # 子系统状态
│   │   ├── thermalStore.ts
│   │   ├── hydraulicStore.ts
│   │   └── electricalStore.ts
│   └── alarmStore.ts
├── controllers/                # 控制逻辑
│   ├── manual/                 # 手动控制
│   │   ├── ManualControl.ts
│   │   └── OperatorInterface.ts
│   ├── automatic/              # 自动控制
│   │   ├── PIDController.ts
│   │   ├── AutoPowerControl.ts
│   │   └── AutoLevelControl.ts
│   └── safety/                 # 安全系统
│       ├── ScramSystem.ts
│       ├── AlarmSystem.ts
│       └── ProtectionLogic.ts
├── workers/                    # Web Workers
│   ├── PhysicsWorker.ts
│   ├── CalculationWorker.ts
│   └── DataProcessingWorker.ts
├── views/                      # 界面
│   ├── panels/                 # 单个面板
│   ├── overview/               # 概览视图
│   │   ├── IntegratedOverview.svelte
│   │   └── KeyParametersDashboard.svelte
│   ├── schematics/             # 系统流程图
│   │   ├── ReactorSchematic.svelte
│   │   └── TurbineSchematic.svelte
│   └── components/             # 可重用组件
│       ├── ParameterDisplay.svelte
│       ├── ControlButton.svelte
│       └── TrendChart.svelte
└── utils/                      # 工具函数
    ├── calculations.ts
    ├── conversions.ts
    └── validators.ts
```

### 4.2 Web Workers实现

**物理计算Worker**：
```typescript
// workers/PhysicsWorker.ts
self.onmessage = (event: MessageEvent) => {
  const { type, data } = event.data;
  
  switch (type) {
    case 'calculate_thermal_hydraulics':
      const thermalResult = calculateThermalHydraulics(data);
      self.postMessage({ type: 'thermal_result', data: thermalResult });
      break;
      
    case 'calculate_neutron_physics':
      const neutronResult = calculateNeutronPhysics(data);
      self.postMessage({ type: 'neutron_result', data: neutronResult });
      break;
      
    case 'update_system_state':
      const stateResult = updateSystemState(data);
      self.postMessage({ type: 'state_result', data: stateResult });
      break;
      
    default:
      console.error('Unknown message type:', type);
  }
};

function calculateThermalHydraulics(params: any): any {
  // 实现热工水力计算
  const { power, coolantFlow, feedwaterTemp, pressure } = params;
  
  // 计算质量平衡
  const massBalance = calculateMassBalance(params);
  
  // 计算能量平衡
  const energyBalance = calculateEnergyBalance(params);
  
  // 计算流动阻力
  const flowResistance = calculateFlowResistance(params);
  
  // 计算水/蒸汽特性
  const waterSteamProps = calculateWaterSteamProperties(pressure, params.temperature);
  
  return {
    massBalance,
    energyBalance,
    flowResistance,
    waterSteamProps,
    timestamp: Date.now()
  };
}

function calculateNeutronPhysics(params: any): any {
  // 实现中子物理计算
  const { neutronFlux, xenonConcentration, iodineConcentration } = params;
  
  // 计算空泡系数效应
  const voidCoefficientEffect = calculateVoidCoefficientEffect(params);
  
  // 计算氙中毒
  const xenonPoisoning = calculateXenonPoisoning(neutronFlux, 1.0, xenonConcentration, iodineConcentration);
  
  // 计算控制棒效应
  const controlRodEffect = calculateControlRodEffect(params);
  
  return {
    voidCoefficientEffect,
    xenonPoisoning,
    controlRodEffect,
    timestamp: Date.now()
  };
}

function updateSystemState(params: any): any {
  // 更新系统状态
  const { currentState, deltaTime } = params;
  
  // 更新反应堆状态
  const reactorState = updateReactorState(currentState.reactor, deltaTime);
  
  // 更新汽轮机状态
  const turbineState = updateTurbineState(currentState.turbine, deltaTime);
  
  // 更新辅助系统状态
  const auxiliaryState = updateAuxiliaryState(currentState.auxiliary, deltaTime);
  
  return {
    reactor: reactorState,
    turbine: turbineState,
    auxiliary: auxiliaryState,
    timestamp: Date.now()
  };
}
```

**主线程Worker管理器**：
```typescript
// utils/WorkerManager.ts
class WorkerManager {
  private physicsWorker: Worker | null = null;
  private calculationWorker: Worker | null = null;
  private dataProcessingWorker: Worker | null = null;
  
  constructor() {
    this.initializeWorkers();
  }
  
  private initializeWorkers(): void {
    // 初始化物理计算Worker
    this.physicsWorker = new Worker(new URL('../workers/PhysicsWorker.ts', import.meta.url), {
      type: 'module'
    });
    
    // 设置消息处理器
    this.physicsWorker.onmessage = this.handlePhysicsWorkerMessage.bind(this);
    
    // 初始化计算Worker
    this.calculationWorker = new Worker(new URL('../workers/CalculationWorker.ts', import.meta.url), {
      type: 'module'
    });
    
    // 初始化数据处理Worker
    this.dataProcessingWorker = new Worker(new URL('../workers/DataProcessingWorker.ts', import.meta.url), {
      type: 'module'
    });
  }
  
  private handlePhysicsWorkerMessage(event: MessageEvent): void {
    const { type, data } = event.data;
    
    switch (type) {
      case 'thermal_result':
        this.handleThermalResult(data);
        break;
      case 'neutron_result':
        this.handleNeutronResult(data);
        break;
      case 'state_result':
        this.handleStateResult(data);
        break;
    }
  }
  
  public calculateThermalHydraulics(params: any): Promise<any> {
    return new Promise((resolve, reject) => {
      if (!this.physicsWorker) {
        reject(new Error('Physics worker not initialized'));
        return;
      }
      
      const messageId = generateMessageId();
      const messageHandler = (event: MessageEvent) => {
        if (event.data.messageId === messageId) {
          this.physicsWorker!.removeEventListener('message', messageHandler);
          resolve(event.data.data);
        }
      };
      
      this.physicsWorker.addEventListener('message', messageHandler);
      this.physicsWorker.postMessage({
        messageId,
        type: 'calculate_thermal_hydraulics',
        data: params
      });
    });
  }
  
  public calculateNeutronPhysics(params: any): Promise<any> {
    return new Promise((resolve, reject) => {
      if (!this.physicsWorker) {
        reject(new Error('Physics worker not initialized'));
        return;
      }
      
      const messageId = generateMessageId();
      const messageHandler = (event: MessageEvent) => {
        if (event.data.messageId === messageId) {
          this.physicsWorker!.removeEventListener('message', messageHandler);
          resolve(event.data.data);
        }
      };
      
      this.physicsWorker.addEventListener('message', messageHandler);
      this.physicsWorker.postMessage({
        messageId,
        type: 'calculate_neutron_physics',
        data: params
      });
    });
  }
  
  private handleThermalResult(data: any): void {
    // 处理热工水力计算结果
    console.log('Thermal result received:', data);
  }
  
  private handleNeutronResult(data: any): void {
    // 处理中子物理计算结果
    console.log('Neutron result received:', data);
  }
  
  private handleStateResult(data: any): void {
    // 处理状态更新结果
    console.log('State result received:', data);
  }
}

export const workerManager = new WorkerManager();
```

## 五、实施路线图详细规划

### 5.1 第一阶段：基础优化（1-2个月）

**第1-2周：物理模型基础改进**
- 实现质量守恒方程
- 实现能量守恒方程
- 添加基本的流动阻力计算
- 实现简化的水/蒸汽特性计算

**第3-4周：中子物理模型**
- 实现正空泡系数效应
- 实现氙-135中毒效应
- 改进控制棒物理特性
- 添加控制棒石墨尖端效应

**第5-6周：系统间耦合**
- 实现给水系统-堆芯水位耦合
- 实现蒸汽压力-汽轮机效率耦合
- 实现凝结水温度-除氧器性能耦合
- 添加系统间延迟和响应时间

**第7-8周：参数校准**
- 校准反应堆核心参数
- 校准汽轮机参数
- 校准辅助系统参数
- 调整系统响应时间

### 5.2 第二阶段：功能扩展（2-3个月）

**第9-12周：自动控制系统**
- 实现PID控制器
- 实现功率自动调节系统
- 实现水位自动控制系统
- 实现压力自动调节系统

**第13-16周：界面优化**
- 实现多视图模式
- 添加系统集成概览视图
- 实现关键参数监控仪表板
- 增强视觉反馈系统

**第17-20周：数据可视化**
- 增强数据趋势功能
- 添加系统流程图
- 实现动态流体流动显示
- 添加交互式元素

### 5.3 第三阶段：高级特性（3-4个月）

**第21-24周：故障模拟**
- 实现管道破裂故障
- 实现泵故障模拟
- 实现阀门故障模拟
- 添加故障级联影响

**第25-28周：真实RBMK特性**
- 完善正空泡系数实现
- 添加控制棒拔出效应
- 实现完整的氙中毒模型
- 添加反应堆中毒恢复过程

**第29-32周：启动/停机流程**
- 实现完整的启动流程
- 实现正常停机流程
- 实现紧急停机流程
- 添加启动/停机检查清单

**第33-36周：性能优化**
- 实现Web Workers后台计算
- 优化数据存储和检索
- 实现计算精度自适应
- 添加预计算和缓存策略

## 六、结论与建议

通过实施上述详细优化建议，Barotrauma反应堆模拟器可以达到专业级模拟器的水平。关键成功因素包括：

1. **物理模型准确性**：基于真实RBMK-1000技术参数和物理原理
2. **系统完整性**：实现所有主要系统和它们之间的相互影响
3. **用户界面质量**：提供直观、信息丰富、响应迅速的控制界面
4. **教育价值**：不仅作为游戏元素，还可作为教育和培训工具

### 优先级建议

1. **最高优先级**：物理模型优化和参数校准（第1-8周）
2. **高优先级**：自动控制系统实现和UI/UX改进（第9-20周）
3. **中优先级**：系统流程图和数据可视化增强（第13-20周）
4. **低优先级**：高级故障模拟和预测性维护功能（第21-36周）

### 预期成果

实施这些优化后，模拟器将具备：
- 更真实的物理行为
- 更完整的系统模拟
- 更好的用户体验
- 更高的教育价值
- 更强的可扩展性

这些改进将使模拟器成为理解核反应堆工作原理和安全操作流程的强大工具，同时保持作为游戏元素的娱乐价值。