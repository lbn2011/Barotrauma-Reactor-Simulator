# Barotrauma 反应堆模拟器技术架构文档

## 1. 系统架构概述

Barotrauma 反应堆模拟器是一个基于现代前端技术栈构建的 RBMK-1000 反应堆模拟系统，旨在提供高度真实的反应堆运行和控制体验。系统采用模块化架构设计，结合 Web Workers 进行高性能计算，确保模拟过程的实时性和准确性。

### 1.1 技术栈

| 技术         | 版本    | 用途       |
| ------------ | ------- | ---------- |
| SvelteKit    | ^2.50.2 | 前端框架   |
| TypeScript   | ~5.9.3  | 类型系统   |
| Tailwind CSS | ^4.1.18 | 样式框架   |
| Web Workers  | 标准    | 后台计算   |
| Chart.js     | ^4.5.1  | 数据可视化 |
| Vite         | ^7.2.5  | 构建工具   |

### 1.2 系统分层

系统采用清晰的分层架构，确保各模块职责明确，便于维护和扩展：

```
┌─────────────────────────┐
│       界面层 (Views)     │
├─────────────────────────┤
│     状态管理 (Stores)    │
├─────────────────────────┤
│    控制逻辑 (Controllers) │
├─────────────────────────┤
│    物理模型 (Models)     │
├─────────────────────────┤
│  Web Workers (计算层)    │
└─────────────────────────┘
```

## 2. 核心模块设计

### 2.1 物理模型模块

物理模型是模拟器的核心，负责计算反应堆的各种物理参数和状态变化。

#### 2.1.1 热工水力模型

**文件位置**: `src/models/thermal/`

| 模块       | 文件名                  | 功能描述                           |
| ---------- | ----------------------- | ---------------------------------- |
| 质量平衡   | massBalance.ts          | 计算各系统的质量变化               |
| 能量平衡   | energyBalance.ts        | 计算能量转换和传递                 |
| 流动阻力   | flowResistance.ts       | 计算流体流动阻力和压降             |
| 水蒸汽特性 | waterSteamProperties.ts | 计算不同状态下水和蒸汽的热力学特性 |

#### 2.1.2 中子物理模型

**文件位置**: `src/models/neutron/`

| 模块       | 文件名               | 功能描述                 |
| ---------- | -------------------- | ------------------------ |
| 空泡系数   | voidCoefficient.ts   | 计算正空泡系数效应       |
| 氙中毒     | xenonPoisoning.ts    | 模拟氙-135中毒效应       |
| 控制棒物理 | controlRodPhysics.ts | 模拟控制棒的物理响应特性 |

#### 2.1.3 系统模型

**文件位置**: `src/models/systems/`

| 模块       | 文件名                      | 功能描述           |
| ---------- | --------------------------- | ------------------ |
| 反应堆堆芯 | reactorCore.ts              | 反应堆核心计算     |
| 汽轮机     | turbine.ts                  | 汽轮机运行模拟     |
| 凝汽器     | condenser.ts                | 凝汽器工作状态模拟 |
| 除氧器     | deaerator.ts                | 除氧器功能模拟     |
| 三冲量控制 | threeImpulseLevelControl.ts | 水位控制系统       |
| 蒸汽旁路   | steamBypass.ts              | 蒸汽旁路系统       |
| 堆芯净化   | corePurification.ts         | 堆芯冷却剂净化系统 |
| 故障模拟   | faultSimulation.ts          | 系统故障模拟       |

### 2.2 状态管理

**文件位置**: `src/lib/stores/reactorStore.ts`

状态管理采用 Svelte 的 writable store 实现，集中管理整个系统的状态数据，确保数据流的一致性和可追踪性。

#### 2.2.1 核心状态结构

| 状态类别   | 描述               | 关键参数                                         |
| ---------- | ------------------ | ------------------------------------------------ |
| 模拟控制   | 控制模拟的运行状态 | isRunning, simulationTime                        |
| 反应堆控制 | 控制棒和功率调节   | controlRods.position, powerRegulation.powerLevel |
| 泵系统     | 各种泵的状态和参数 | recirculationPumps, emergencyCoolingPumps        |
| 汽轮机系统 | 汽轮机运行状态     | turbine.status, turbine.load                     |
| 辅助系统   | 其他辅助系统状态   | condenserVacuum, deaerator                       |
| 核心参数   | 反应堆核心物理参数 | core.temperature, core.pressure                  |
| 物理模型   | 物理计算相关参数   | physics.neutron, physics.reactivity              |
| 故障模拟   | 故障和安全系统     | faultSimulation.activeFaults                     |
| 操作日志   | 系统运行记录       | logs                                             |

### 2.3 界面模块

**文件位置**: `src/routes/`

界面模块采用 Svelte 组件化设计，提供直观、交互性强的用户界面。

#### 2.3.1 控制面板

| 面板         | 文件名                              | 功能描述             |
| ------------ | ----------------------------------- | -------------------- |
| 反应堆控制棒 | control-rod/+page.svelte            | 控制棒位置和状态控制 |
| 功率调节     | power-control/+page.svelte          | 反应堆功率设定和调节 |
| 再循环泵     | recirculation-pump/+page.svelte     | 再循环泵控制         |
| 应急冷却泵   | emergency-cooling-pump/+page.svelte | 应急冷却系统控制     |
| 汽轮机控制   | turbine-control/+page.svelte        | 汽轮机运行参数控制   |
| 数据趋势     | data-trend/+page.svelte             | 关键参数趋势显示     |
| 警报CRT      | alarm-crt/+page.svelte              | 系统警报显示和处理   |

#### 2.3.2 通用组件

**文件位置**: `src/lib/components/ui/`

| 组件       | 功能描述       | 文件位置             |
| ---------- | -------------- | -------------------- |
| 按钮       | 通用按钮组件   | button/              |
| 卡片       | 内容容器组件   | card/                |
| 图表       | 数据可视化组件 | chart/               |
| 确认对话框 | 操作确认组件   | confirmation-dialog/ |
| 历史查看器 | 历史数据查看   | history-viewer/      |
| 输入框     | 文本输入组件   | input/               |
| 滑块       | 参数调节组件   | slider/              |
| 系统示意图 | 系统流程可视化 | system-schematic/    |

### 2.4 Web Workers

**文件位置**: `src/workers/`

Web Workers 负责处理计算密集型任务，确保主线程的流畅运行。

| Worker       | 文件名                       | 功能描述               |
| ------------ | ---------------------------- | ---------------------- |
| 物理计算     | physicsCalculation.worker.ts | 执行复杂的物理模型计算 |
| 数据处理     | dataProcessing.worker.ts     | 处理和分析模拟数据     |
| Worker管理器 | workerManager.ts             | 管理Worker的创建和通信 |

## 3. 数据流设计

### 3.1 主要数据流向

```
┌──────────────┐     用户操作     ┌──────────────┐
│    界面层     │ ─────────────→ │ 状态管理层    │
└──────────────┘                 └──────────────┘
        ↑                           │
        │     状态更新               │
        │ ←──────────────────────── │
        │                           │
        │     计算请求               │
        │ ─────────────────────────→ │
        │                           │
        │                           ↓
┌──────────────┐     计算结果     ┌──────────────┐
│  Web Workers  │ ←────────────── │ 物理模型层    │
└──────────────┘                 └──────────────┘
```

### 3.2 状态更新流程

1. **用户操作**：用户通过界面控件进行操作（如调节控制棒位置）
2. **状态更新**：状态管理层接收操作并更新相应状态
3. **计算触发**：状态变化触发物理模型计算
4. **后台计算**：复杂计算通过 Web Workers 在后台执行
5. **结果反馈**：计算结果更新到状态管理层
6. **界面刷新**：界面层响应状态变化，更新显示

## 4. 核心功能实现

### 4.1 反应堆核心计算

#### 4.1.1 功率计算

```typescript
// 核心功率计算逻辑
export function calculateReactorPower(state: ReactorState): number {
  // 基于中子通量和反应性计算功率
  const { neutron, reactivity } = state.physics;

  // 计算热功率
  const thermalPower = neutron.φ * reactivity.total * 30; // 3000MW 为额定功率

  // 限制功率范围
  return Math.max(0, Math.min(100, thermalPower));
}
```

#### 4.1.2 温度和压力计算

```typescript
// 温度和压力计算
export function calculateCoreParameters(powerLevel: number): {
  temperature: number;
  pressure: number;
} {
  // 基于功率水平计算温度和压力
  const temperature = 250 + powerLevel * 0.8; // 250-330°C
  const pressure = 6.5 + powerLevel * 0.01; // 6.5-7.5 MPa

  return { temperature, pressure };
}
```

### 4.2 控制棒系统

#### 4.2.1 控制棒物理特性

```typescript
// 控制棒反应性计算
export function calculateControlRodReactivity(rodPosition: number): number {
  // 控制棒位置 (0-100%) 到反应性的转换
  // 石墨尖端效应 (前20%插入深度)
  if (rodPosition < 20) {
    return rodPosition * 0.0002; // 正反应性贡献
  }

  // 吸收效应 (后80%插入深度)
  const insertionDepth = (rodPosition - 20) / 80;
  return -0.1 * insertionDepth; // 负反应性贡献
}
```

### 4.3 故障模拟系统

#### 4.3.1 故障检测和处理

```typescript
// 故障检测逻辑
export function detectFaults(state: ReactorState): Fault[] {
  const activeFaults: Fault[] = [];

  // 检测温度异常
  if (state.core.temperature > 320) {
    activeFaults.push({
      id: 'high-temperature',
      description: '堆芯温度过高',
      severity: 'high',
      recommendedAction: '降低功率水平，检查冷却系统',
    });
  }

  // 检测压力异常
  if (state.core.pressure > 7.5) {
    activeFaults.push({
      id: 'high-pressure',
      description: '堆芯压力过高',
      severity: 'high',
      recommendedAction: '启动蒸汽旁路系统，降低压力',
    });
  }

  // 检测其他系统故障...

  return activeFaults;
}
```

### 4.4 数据可视化

#### 4.4.1 趋势图表

```typescript
// 趋势数据处理
export function processTrendData(state: ReactorState): TrendData {
  return {
    timePoints: state.trends.timePoints,
    powerData: state.trends.powerData,
    temperatureData: state.trends.temperatureData,
    pressureData: state.trends.pressureData,
  };
}
```

## 5. 性能优化策略

### 5.1 计算性能

1. **Web Workers**：将计算密集型任务移至后台线程
2. **计算缓存**：缓存中间计算结果，避免重复计算
3. **增量计算**：采用增量计算策略，只更新变化的部分
4. **计算频率控制**：根据参数重要性调整计算频率

### 5.2 渲染性能

1. **虚拟滚动**：处理大量数据时使用虚拟滚动
2. **组件懒加载**：按需加载界面组件
3. **状态优化**：避免不必要的状态更新和重渲染
4. **CSS优化**：使用 Tailwind CSS 实现高效样式管理

### 5.3 内存管理

1. **对象池**：重用频繁创建的对象
2. **内存监控**：定期清理不再使用的内存
3. **数据结构优化**：选择合适的数据结构减少内存占用

## 6. 扩展性设计

### 6.1 模块扩展

系统采用模块化设计，支持以下扩展方式：

1. **新增物理模型**：在 `src/models/` 目录下添加新的模型文件
2. **新增控制面板**：在 `src/routes/panels/` 目录下添加新的面板
3. **新增组件**：在 `src/lib/components/` 目录下添加新的UI组件
4. **新增计算模块**：在 `src/workers/` 目录下扩展计算功能

### 6.2 配置系统

系统支持通过配置文件调整各种参数，便于适应不同的模拟场景：

1. **物理参数配置**：调整反应堆物理特性参数
2. **界面配置**：自定义界面布局和显示选项
3. **警报阈值配置**：设置各种参数的警报阈值

## 7. 安全设计

### 7.1 输入验证

所有用户输入都经过严格验证，确保参数在安全范围内：

```typescript
// 输入验证示例
export function validateControlRodPosition(position: number): number {
  return Math.max(0, Math.min(100, position));
}
```

### 7.2 边界检查

系统对所有物理参数进行边界检查，防止数值异常：

```typescript
// 边界检查示例
export function checkParameterBounds(value: number, min: number, max: number): number {
  if (value < min) {
    console.warn(`Parameter below minimum: ${value}, setting to ${min}`);
    return min;
  }
  if (value > max) {
    console.warn(`Parameter above maximum: ${value}, setting to ${max}`);
    return max;
  }
  return value;
}
```

### 7.3 错误处理

系统实现了完善的错误处理机制，确保模拟过程的稳定性：

```typescript
// 错误处理示例
export async function safeCalculatePhysics(state: ReactorState) {
  try {
    return await workerManager.calculateReactorCore(state);
  } catch (error) {
    console.error('Physics calculation error:', error);
    // 返回安全的默认值
    return getDefaultPhysicsState();
  }
}
```

## 8. 部署与构建

### 8.1 开发环境

```bash
# 安装依赖
pnpm install

# 启动开发服务器
pnpm run dev
```

### 8.2 生产构建

```bash
# 构建生产版本
pnpm run build

# 预览生产构建
pnpm run preview

# 部署到 Cloudflare Pages
pnpm run deploy
```

### 8.3 构建优化

1. **代码分割**：按路由和功能分割代码
2. **树摇**：移除未使用的代码
3. **压缩**：压缩 JavaScript 和 CSS
4. **缓存策略**：合理设置资源缓存

## 9. 监控与维护

### 9.1 日志系统

系统实现了详细的日志记录，便于问题诊断：

```typescript
// 日志记录示例
export function logSystemEvent(event: string, details?: any) {
  reactorStore.update((state) => ({
    ...state,
    logs: [
      ...state.logs,
      {
        timestamp: Date.now(),
        message: `${event}${details ? `: ${JSON.stringify(details)}` : ''}`,
      },
    ].slice(-50), // 保留最近50条日志
  }));
}
```

### 9.2 性能监控

系统集成了性能监控，追踪关键操作的执行时间：

```typescript
// 性能监控示例
export function measurePerformance<T>(name: string, fn: () => T): T {
  const start = performance.now();
  const result = fn();
  const end = performance.now();
  console.log(`${name} took ${end - start}ms`);
  return result;
}
```

### 9.3 常见问题诊断

| 问题         | 可能原因            | 解决方案                         |
| ------------ | ------------------- | -------------------------------- |
| 计算性能下降 | Web Worker 负载过高 | 优化计算算法，增加计算缓存       |
| 界面响应缓慢 | 渲染频率过高        | 减少不必要的重渲染，使用虚拟滚动 |
| 内存使用过高 | 数据结构不合理      | 优化数据结构，增加内存清理       |
| 模拟结果异常 | 物理参数设置错误    | 检查参数配置，重置为默认值       |

## 10. 总结

Barotrauma 反应堆模拟器采用现代化的技术架构，实现了高性能、可扩展的 RBMK-1000 反应堆模拟系统。系统通过模块化设计、Web Workers 计算和组件化界面，提供了高度真实的反应堆运行和控制体验。

### 10.1 技术优势

1. **高性能计算**：Web Workers 实现后台计算，保证界面流畅
2. **模块化设计**：清晰的模块划分，便于维护和扩展
3. **实时响应**：优化的数据流设计，确保操作实时反馈
4. **可视化效果**：丰富的数据可视化，直观展示系统状态
5. **可扩展性**：良好的扩展性设计，支持功能扩展和定制

### 10.2 应用场景

1. **教育训练**：核工程相关专业的教学和培训
2. **科普宣传**：向公众普及核能知识和安全意识
3. **研究模拟**：反应堆运行特性和故障分析研究
4. **应急演练**：核电厂应急响应流程演练

通过持续的优化和扩展，Barotrauma 反应堆模拟器将成为一个功能更加完善、模拟更加真实的反应堆模拟平台，为核能相关领域提供有力的工具支持。

---

© 2026 lbn2011和ai共同开发

本技术架构文档如有更新，恕不另行通知。
