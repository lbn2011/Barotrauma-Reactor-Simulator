# Barotrauma 反应堆模拟器系统流程图和架构图

## 1. 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Barotrauma 反应堆模拟器                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────┐     ┌───────────────┐     ┌───────────────┐              │
│  │   用户界面层   │────>│  状态管理层   │────>│  物理模型层   │              │
│  │   (Svelte)    │     │  (reactorStore) │     │  (models/)    │              │
│  └───────────────┘     └───────────────┘     └───────────────┘              │
│         │                     │                     │                        │
│         │                     ▼                     │                        │
│         │              ┌───────────────┐           │                        │
│         │              │   日志系统     │<──────────┘                        │
│         │              │  (logger.ts)  │                                    │
│         │              └───────────────┘                                    │
│         │                     │                                             │
│         │                     ▼                                             │
│         │              ┌───────────────┐                                    │
│         │              │  日志存储     │                                    │
│         │              │ (logStorage)  │                                    │
│         │              └───────────────┘                                    │
│         │                                                                   │
│  ┌───────────────┐     ┌───────────────┐     ┌───────────────┐              │
│  │  Web Workers  │<────│  状态管理层   │<────│  物理模型层   │              │
│  │  (计算密集型)  │     │  (reactorStore) │     │  (models/)    │              │
│  │               │────>│   日志系统     │     │               │              │
│  │ (workerLogger)│     └───────────────┘     └───────────────┘              │
│  └───────────────┘                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 2. 系统流程图

### 2.1 反应堆控制流程

```
┌─────────────────────────┐
│  开始模拟               │
└──────────┬──────────────┘
           ▼
┌─────────────────────────┐
│  读取当前状态           │
└──────────┬──────────────┘
           ▼
┌─────────────────────────┐
│  计算中子物理模型       │
│  - 空泡系数效应         │
│  - 氙中毒效应           │
│  - 控制棒效应           │
└──────────┬──────────────┘
           ▼
┌─────────────────────────┐
│  计算总反应性           │
└──────────┬──────────────┘
           ▼
┌─────────────────────────┐
│  更新反应堆功率         │
└──────────┬──────────────┘
           ▼
┌─────────────────────────┐
│  计算热工水力参数       │
│  - 质量平衡             │
│  - 能量平衡             │
│  - 水位控制             │
└──────────┬──────────────┘
           ▼
┌─────────────────────────┐
│  更新系统状态           │
└──────────┬──────────────┘
           ▼
┌─────────────────────────┐
│  检查故障和警报         │
└──────────┬──────────────┘
           ▼
┌─────────────────────────┐
│  生成趋势数据           │
└──────────┬──────────────┘
           ▼
┌─────────────────────────┐
│  渲染用户界面           │
└──────────┬──────────────┘
           ▼
┌─────────────────────────┐
│  等待下一个时间步长     │
└──────────┬──────────────┘
           ▼
┌─────────────────────────┐
│  结束当前时间步         │
└─────────────────────────┘
```

### 2.2 数据流程图

```
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│   用户输入     │────>│  状态管理层    │────>│  Web Workers  │
└───────────────┘     └───────────────┘     │  (计算密集型)  │
                                            └───────────────┘
                                                    │
                                                    ▼
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│   用户界面     │<────│  状态管理层    │<────│  物理模型层    │
└───────────────┘     └───────────────┘     └───────────────┘
      │                     │                     │
      │                     ▼                     │
      │              ┌───────────────┐            │
      └─────────────>│   日志系统     │<───────────┘
                     │  (logger.ts)  │
                     └───────────────┘
                            │
                            ▼
                     ┌───────────────┐
                     │  日志存储     │
                     │ (logStorage)  │
                     └───────────────┘
                            │
                            ▼
                     ┌───────────────┐
                     │  日志管理     │
                     │ (logManager)  │
                     └───────────────┘
                            │
                            ▼
                     ┌───────────────┐
                     │  日志导出     │
                     │ (JSON/CSV)    │
                     └───────────────┘
```

### 2.3 日志系统流程

```
┌─────────────────────────┐
│  应用程序各模块         │
│  - UI组件              │
│  - Store层             │
│  - 物理模型            │
│  - Web Workers         │
└──────────┬──────────────┘
           │
           │ logger.log()
           ▼
┌─────────────────────────┐
│  日志系统 (logger.ts)   │
│  - 日志级别检查         │
│  - 模块标识             │
│  - 性能监控             │
│  - 内存跟踪             │
└──────────┬──────────────┘
           │
           ├──────────────┬──────────────┐
           │              │              │
           ▼              ▼              ▼
    ┌──────────┐   ┌──────────┐   ┌──────────┐
    │ 控制台   │   │ 日志存储 │   │ Web Worker│
    │ 输出     │   │         │   │ 传输     │
    └──────────┘   └──────────┘   └──────────┘
                        │
                        ▼
                ┌───────────────┐
                │ 日志管理器    │
                │ (logManager)  │
                └───────────────┘
                        │
                        ├──────────────┬──────────────┐
                        ▼              ▼              ▼
                 ┌──────────┐   ┌──────────┐   ┌──────────┐
                 │ 日志查询 │   │ 日志分析 │   │ 日志导出 │
                 └──────────┘   └──────────┘   └──────────┘
```

## 3. 模块关系图

### 3.1 核心模块关系

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  reactorStore   │────>│  workerManager  │────>│  physics models │
└─────────────────┘     └─────────────────┘     └─────────────────┘
       │                        │                        │
       │                        │                        │
       │                        │                        │
       └────────────────────────┼────────────────────────┘
                                │
                                ▼
                        ┌─────────────────┐
                        │  日志系统       │
                        │  (logger.ts)    │
                        └─────────────────┘
                                │
                                ▼
                        ┌─────────────────┐
                        │  日志存储       │
                        │ (logStorage)    │
                        └─────────────────┘
                                │
                                ▼
                        ┌─────────────────┐
                        │  日志管理器     │
                        │ (logManager)    │
                        └─────────────────┘
```

### 3.2 物理模型模块关系

```
┌─────────────────┐     ┌─────────────────┐
│  voidCoefficient │────>│  xenonPoisoning │
└─────────────────┘     └─────────────────┘
       │                        │
       ▼                        │
┌─────────────────┐     ┌─────────────────┐
│  controlRodPhysics │<────│  reactorCore   │
└─────────────────┘     └─────────────────┘
       │                        │
       │                        │
       └────────────────────────┘
                                │
                                ▼
                        ┌─────────────────┐
                        │  日志系统       │
                        │  (logger.ts)    │
                        └─────────────────┘
```

### 3.3 日志系统模块关系

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  logger.ts      │────>│  logStorage.ts  │────>│  logManager.ts  │
│  (核心日志器)   │     │  (日志存储)     │     │  (日志管理)     │
└─────────────────┘     └─────────────────┘     └─────────────────┘
       │                        │                        │
       │                        │                        │
       ▼                        ▼                        ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  workerLogger   │     │  loggerConfig   │     │  loggerCompat   │
│  (Worker日志)   │     │  (配置定义)     │     │  (兼容层)       │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

## 4. 系统架构详细说明

### 4.1 前端架构

- **框架**: SvelteKit
- **状态管理**: Svelte stores (reactorStore)
- **样式**: Tailwind CSS
- **图表**: Chart.js

### 4.2 后端架构

- **计算引擎**: Web Workers
- **物理模型**: TypeScript 模块
- **状态管理**: Svelte stores

### 4.3 数据流

1. **用户输入** → 前端组件
2. **组件事件** → reactorStore
3. **状态更新** → workerManager
4. **计算请求** → Web Workers
5. **计算结果** → reactorStore
6. **状态变化** → 前端组件
7. **UI 更新** → 用户界面

## 5. 关键流程说明

### 5.1 启动流程

1. 初始化系统状态
2. 启动 Web Workers
3. 开始模拟循环
4. 渲染初始界面

### 5.2 停堆流程

1. 接收停堆指令
2. 插入控制棒
3. 监测反应性变化
4. 确认功率下降
5. 完成停堆操作

### 5.3 故障处理流程

1. 检测故障条件
2. 触发警报系统
3. 执行安全措施
4. 更新故障状态
5. 记录故障数据

## 6. 系统组件关系

```
┌────────────────────────────────────────────────────────────────────────────┐
│                                    系统组件                               │
├───────────────┬───────────────┬───────────────┬───────────────┬───────────────┤
│  反应堆核心    │  汽轮机系统   │  冷却系统     │  控制系统     │  监控系统     │
├───────────────┼───────────────┼───────────────┼───────────────┼───────────────┤
│  - 堆芯模型    │  - 汽轮机模型  │  - 泵模型     │  - PID控制    │  - 数据采集   │
│  - 中子物理    │  - 旁路系统    │  - 流量控制   │  - 逻辑控制   │  - 趋势分析   │
│  - 热工水力    │  - 发电机模型  │  - 温度控制   │  - 安全逻辑   │  - 警报系统   │
└───────────────┴───────────────┴───────────────┴───────────────┴───────────────┘
```

## 7. 总结

本系统流程图和架构图文档详细说明了 Barotrauma 反应堆模拟器的整体结构和关键流程，包括：

1. **系统架构**：前端-状态管理层-物理模型层-Web Workers 的分层结构
2. **核心流程**：反应堆控制、物理计算、状态更新、界面渲染
3. **模块关系**：reactorStore 作为中心，连接用户界面和物理模型
4. **数据流**：清晰的单向数据流，确保系统稳定性和可预测性
5. **日志系统**：全面的日志记录、存储、管理和分析系统

通过这种结构化的设计，模拟器能够准确模拟 RBMK-1000 反应堆的关键特性，包括正空泡系数、控制棒石墨尖端效应和氙中毒等复杂物理现象，为用户提供逼真的反应堆运行体验。

## 8. 日志系统架构

### 8.1 日志系统组成

日志系统由以下核心模块组成：

| 模块         | 文件            | 功能描述                                   |
| ------------ | --------------- | ------------------------------------------ |
| 核心日志器   | logger.ts       | 提供日志记录、性能监控、内存跟踪等核心功能 |
| 日志配置     | loggerConfig.ts | 定义日志级别、模块类型、配置接口等         |
| 日志存储     | logStorage.ts   | 管理日志的存储、查询、统计和导出           |
| 日志管理器   | logManager.ts   | 提供高级日志管理功能，如查询、分析、导出   |
| Worker日志器 | workerLogger.ts | 为Web Workers提供日志记录功能              |
| 兼容层       | loggerCompat.ts | 保持与原有API的兼容性                      |

### 8.2 日志级别

| 级别  | 值  | 使用场景                                 |
| ----- | --- | ---------------------------------------- |
| FATAL | 0   | 致命错误，导致应用程序无法继续运行       |
| ERROR | 1   | 错误事件，但不影响应用程序继续运行       |
| WARN  | 2   | 警告信息，可能导致问题但不会立即影响运行 |
| INFO  | 3   | 正常运行状态和重要事件                   |
| DEBUG | 4   | 调试信息，用于开发和调试                 |
| TRACE | 5   | 详细的执行路径和调用栈信息               |

### 8.3 模块类型

| 模块       | 说明                      |
| ---------- | ------------------------- |
| UI         | 用户界面层组件            |
| STORE      | 状态管理层（MobX stores） |
| PHYSICS    | 物理计算层                |
| WORKER     | Web Workers               |
| CONTROLLER | 控制器层                  |
| MODEL      | 模型层                    |

### 8.4 日志系统特性

#### 8.4.1 核心功能

- **多级别日志记录**：支持6个日志级别，可根据需要动态调整
- **模块化日志**：按模块类型分类日志，便于管理和分析
- **性能监控**：自动跟踪关键操作的执行时间和内存使用
- **动态配置**：支持运行时调整日志级别和配置
- **Web Workers支持**：Worker日志自动传输到主线程

#### 8.4.2 存储和管理

- **内存存储**：高效的内存日志存储，支持快速查询
- **日志过滤**：支持按级别、模块、时间范围、关键词过滤
- **统计分析**：提供日志统计和分析功能
- **导出功能**：支持JSON和CSV格式导出日志

#### 8.4.3 性能优化

- **级别过滤**：在日志记录前就进行级别过滤，避免不必要的对象创建
- **内存管理**：使用固定大小的日志存储，自动清理旧日志
- **可选功能**：性能跟踪等功能可按需启用，生产环境可关闭
- **批量处理**：避免在循环中记录日志

### 8.5 日志记录示例

#### 8.5.1 基本日志记录

```typescript
import logger, { ModuleType } from '@/lib/utils/logger';

// 记录不同级别的日志
logger.fatal(ModuleType.UI, 'Fatal error occurred', { error: 'details' });
logger.error(ModuleType.STORE, 'Error in store', { error });
logger.warn(ModuleType.MODEL, 'Warning condition', { value: 100 });
logger.info(ModuleType.CONTROLLER, 'Operation completed', { result });
logger.debug(ModuleType.PHYSICS, 'Debug information', { data });
logger.trace(ModuleType.WORKER, 'Trace execution', { step: 1 });
```

#### 8.5.2 性能监控

```typescript
// 方法1: 使用time/timeEnd
logger.time('calculation', ModuleType.MODEL);
// 执行计算
logger.timeEnd('calculation', ModuleType.MODEL);

// 方法2: 手动跟踪性能
const startTime = performance.now();
// 执行操作
const duration = performance.now() - startTime;
logger.trackPerformance('operation', duration, ModuleType.MODEL);
```

#### 8.5.3 日志查询

```typescript
import logManager from '@/lib/utils/logManager';

// 获取所有日志
const allLogs = logManager.getLogs();

// 按模块过滤
const modelLogs = logManager.getLogsByModule(ModuleType.MODEL);

// 按级别过滤
const errorLogs = logManager.getLogsByLevel(LogLevel.ERROR);

// 搜索日志
const searchResults = logManager.searchLogs('error');
```

### 8.6 日志配置建议

#### 8.6.1 开发环境

```typescript
logger.updateConfig({
  globalLevel: LogLevel.DEBUG,
  enableConsole: true,
  enableStorage: true,
  enableWorkerLogging: true,
  enablePerformanceTracking: true,
  maxStorageSize: 10000,
});
```

#### 8.6.2 生产环境

```typescript
logger.updateConfig({
  globalLevel: LogLevel.INFO,
  enableConsole: false,
  enableStorage: true,
  enableWorkerLogging: true,
  enablePerformanceTracking: false,
  maxStorageSize: 5000,
});
```

### 8.7 日志系统在项目中的应用

日志系统已集成到项目的各个层次：

- **用户界面层**：MainDashboard.svelte等组件记录用户交互和组件生命周期
- **状态管理层**：rootStore.ts、systemsStore.ts等记录状态变化和计算过程
- **控制器层**：workerManager.ts记录Worker管理和通信
- **物理模型层**：thermal.ts、neutron.ts等记录物理计算过程
- **Web Workers**：通过workerLogger记录Worker内部操作

通过全面的日志记录，系统能够：

1. **追踪问题**：快速定位和诊断问题
2. **性能分析**：分析系统性能瓶颈
3. **运行监控**：实时监控系统运行状态
4. **审计追踪**：记录系统操作历史
5. **调试支持**：提供详细的调试信息

---

© 2026 lbn2011和ai共同开发

本系统流程图和架构图文档如有更新，恕不另行通知。
